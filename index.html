<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jazz Piano Voicings</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #f4f4f4;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-size: 3rem;
            margin-bottom: 2rem;
            background: linear-gradient(45deg, #d4af37, #ff6b6b, #a8c8ec);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 300;
            letter-spacing: 2px;
        }

        .mode-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            gap: 1rem;
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #a8c8ec;
            color: #f4f4f4;
            padding: 1rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            backdrop-filter: blur(10px);
        }

        .mode-btn.active {
            background: #a8c8ec;
            color: #1a1a2e;
            box-shadow: 0 4px 20px rgba(168, 200, 236, 0.3);
        }

        .mode-btn:hover {
            transform: translateY(-2px);
        }

        .mode-section {
            display: none;
        }

        .mode-section.active {
            display: block;
        }

        /* Browse Mode Styles */
        .chord-type-navigation {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(168, 200, 236, 0.3);
            border-radius: 15px;
            padding: 1rem;
            z-index: 1000;
            min-width: 160px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(-10px);
        }

        #browse-mode.active .chord-type-navigation {
            opacity: 1;
            transform: translateY(0);
        }

        .chord-type-navigation .nav-title {
            color: #d4af37;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(168, 200, 236, 0.2);
            padding-bottom: 0.5rem;
        }

        .chord-type-navigation .nav-items {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .chord-type-navigation .nav-item {
            color: #a8c8ec;
            text-decoration: none;
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid transparent;
        }

        .chord-type-navigation .nav-item:hover {
            background: rgba(168, 200, 236, 0.15);
            border-color: rgba(168, 200, 236, 0.3);
            color: #f4f4f4;
            transform: translateX(-2px);
        }

        .chord-type-navigation .nav-item.active {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
            color: #d4af37;
            font-weight: bold;
        }

        /* Collapsible navigation panel styles */
        .chord-type-navigation.collapsed {
            min-width: 40px;
            max-width: 40px;
            padding: 0.5rem 0.3rem;
        }

        .chord-type-navigation.collapsed .nav-title,
        .chord-type-navigation.collapsed .nav-items {
            display: none;
        }

        .nav-toggle {
            position: absolute;
            top: -8px;
            right: -8px;
            background: rgba(212, 175, 55, 0.9);
            border: 2px solid #d4af37;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            color: #1a1a2e;
            font-weight: bold;
            transition: all 0.2s ease;
            z-index: 1001;
        }

        .nav-toggle:hover {
            background: #d4af37;
            transform: scale(1.1);
        }

        .chord-type-navigation.collapsed .nav-toggle {
            position: static;
            margin: 0 auto;
        }

        /* Responsive styles for navigation panel */
        @media (max-width: 1024px) {
            .chord-type-navigation {
                position: fixed;
                top: 20px;
                right: 20px;
                left: auto;
                min-width: 140px;
                max-width: 180px;
            }
        }

        @media (max-width: 768px) {
            .chord-type-navigation {
                position: static;
                margin: 0 auto 1.5rem auto;
                width: 100%;
                max-width: none;
                border-radius: 12px;
            }

            .chord-type-navigation .nav-items {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 0.5rem;
                justify-content: center;
            }

            .chord-type-navigation .nav-item {
                flex: 0 1 auto;
                min-width: 70px;
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
            }

            #browse-mode.active .chord-type-navigation {
                opacity: 1;
                transform: none;
            }

            /* Mobile collapsible adjustments */
            .chord-type-navigation.collapsed {
                width: 60px;
                min-width: 60px;
                margin: 0 auto 1rem auto;
            }

            .nav-toggle {
                position: static !important;
                margin: 0 auto;
            }
        }

        .chord-type {
            margin-bottom: 3rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .chord-type h2 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 1.5rem;
            color: #d4af37;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .voicing-table {
            display: grid;
            gap: 1.5rem;
        }

        .scale-row {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid #a8c8ec;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .scale-row-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .scale-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #a8c8ec;
            margin-bottom: 0.5rem;
            text-transform: capitalize;
        }

        .voicing-grid {
            display: grid;
            gap: 1rem;
            width: 100%;
            overflow: hidden;
            padding: 2px 1rem;
        }

        .voicing-cell {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            border: 2px solid #a8c8ec;
            transition: all 0.3s ease;
            min-height: 100px;
            min-width: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: pointer;
        }

        .voicing-cell:hover {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-1px) scale(1.01);
        }

        .voicing-cell.selected {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }

        .chord-notes {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            line-height: 1.4;
            color: #f4f4f4;
            white-space: pre-line;
            font-weight: bold;
        }

        .chord-notes .top-note {
            color: #d4af37;
            font-weight: bold;
            text-shadow: 0 0 4px rgba(212, 175, 55, 0.3);
        }

        .empty-cell {
            opacity: 0.3;
            cursor: not-allowed;
        }


        /* Progression Creator Styles */
        .progression-creator {
            display: grid;
            grid-template-columns: minmax(320px, 350px) 1fr;
            gap: 1.5rem;
            height: 75vh;
            max-width: 100%;
            overflow: hidden;
        }

        .controls-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .control-group {
            margin-bottom: 2rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #ffd700;
            font-weight: bold;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #f4f4f4;
            font-size: 1rem;
        }

        .control-group select option {
            background: #1a1a2e;
            color: #f4f4f4;
        }

        .chord-bank {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 0.75rem;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chord-bank h3 {
            color: #a8c8ec;
            margin-bottom: 0.75rem;
            text-align: center;
            font-size: 1.1rem;
        }

        .root-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.25rem;
            margin-bottom: 0.5rem;
            flex: 1;
            overflow: hidden;
            align-content: start;
            padding: 2px;
        }

        .root-option {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #a8c8ec;
            color: #f4f4f4;
            padding: 0.3rem;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 35px;
        }

        .root-option:hover {
            background: rgba(168, 200, 236, 0.2);
            transform: scale(1.02);
        }

        .root-option.selected {
            background: rgba(168, 200, 236, 0.3);
            border-color: #d4af37;
        }

        .chord-type-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .chord-type-option {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #a8c8ec;
            color: #f4f4f4;
            padding: 0.6rem;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            position: relative;
        }

        .chord-type-option:hover {
            background: rgba(168, 200, 236, 0.2);
            transform: scale(1.02);
        }

        .chord-type-option:hover::after {
            content: "Double-click to add";
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #ffd700;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            z-index: 100;
        }

        .back-to-roots {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            color: #f4f4f4;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-to-roots:hover {
            background: rgba(255, 107, 107, 0.3);
            transform: translateY(-1px);
        }

        .chord-type-menu h4 {
            color: #ffd700;
            margin-bottom: 1rem;
        }

        .root-selection h4 {
            color: #4ecdc4;
            margin-bottom: 1rem;
        }

        .note-headers {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
            width: 100%;
            padding: 0 1rem;
            position: relative;
        }

        .note-header {
            text-align: center;
            font-weight: bold;
            color: #d4af37;
            font-size: 1.1rem;
            position: relative;
        }

        .chord-type {
            position: relative;
        }

        .progression-area {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            max-width: 100%;
            overflow-x: auto;
        }

        .progression-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .progression-header h2 {
            color: #d4af37;
            margin: 0;
        }

        .progression-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .control-group {
            display: flex;
            gap: 0.5rem;
        }

        .history-actions {
            display: flex;
            gap: 0.3rem;
        }

        .primary-actions {
            display: flex;
            gap: 0.5rem;
        }

        .save-btn, .load-btn, .clear-btn {
            background: rgba(168, 200, 236, 0.2);
            border: 2px solid #a8c8ec;
            color: #a8c8ec;
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .undo-btn, .redo-btn {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid rgba(212, 175, 55, 0.3);
            color: #d4af37;
            padding: 0.6rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            font-weight: bold;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .undo-btn:hover:not(:disabled), .redo-btn:hover:not(:disabled) {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .undo-btn:disabled, .redo-btn:disabled {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .clear-btn {
            background: rgba(255, 107, 107, 0.2);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .save-btn:hover, .load-btn:hover {
            background: rgba(168, 200, 236, 0.4);
            transform: translateY(-2px);
        }

        .clear-btn:hover {
            background: rgba(255, 107, 107, 0.4);
            transform: translateY(-2px);
        }

        .progression-container {
            min-height: 400px;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-start;
            justify-content: center;
        }

        .chord-slot {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #a8c8ec;
            border-radius: 12px;
            padding: 1.2rem;
            min-width: 180px;
            max-width: 220px;
            height: 580px;
            transition: all 0.3s ease;
            flex-shrink: 1;
            display: flex;
            flex-direction: column;
        }

        .chord-slot:hover {
            border-color: #d4af37;
        }

        .chord-slot.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .chord-slot.drag-over {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .drag-handle {
            color: #8B7D6B;
            cursor: grab;
            font-weight: bold;
            margin-right: 8px;
            user-select: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .drop-zone {
            width: 4px;
            height: 100%;
            background: #ffd700;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.2s ease;
            margin: 0 8px;
        }

        .drop-zone.active {
            opacity: 1;
        }

        .voice-leading-connector {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            margin: 0 0.5rem;
            align-self: flex-start;
            padding-top: 15.05rem;
            justify-content: flex-start;
        }

        .voice-leading-connector .movement-summary {
            margin-top: 1rem;
        }

        .creator-movement-summary {
            margin-top: 2rem;
            display: flex;
            justify-content: center;
        }

        .voice-movement {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 4px;
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 2rem;
            margin: 0.2rem 0;
        }

        .voice-movement.common {
            background: rgba(76, 175, 80, 0.6);
            border-color: #4CAF50;
            color: white;
        }

        .voice-movement.step {
            background: rgba(33, 150, 243, 0.6);
            border-color: #2196F3;
            color: white;
        }

        .voice-movement.leap {
            background: rgba(255, 152, 0, 0.6);
            border-color: #FF9800;
            color: white;
        }

        .chord-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1.2rem;
        }

        .chord-slot .chord-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0 0.5rem;
        }

        .chord-slot .drag-handle {
            margin-right: 0;
            flex: 0 0 auto;
        }

        .chord-slot .chord-symbol {
            flex: 1;
            text-align: center;
        }

        .chord-slot .remove-chord {
            flex: 0 0 auto;
        }

        .chord-symbol {
            font-size: 1.8rem;
            font-weight: bold;
            color: #d4af37;
        }

        .remove-chord {
            background: #ff6b6b;
            border: none;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .voicing-selector {
            margin-bottom: 1rem;
        }

        .voicing-navigation {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .top-note-selector {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .top-note-label {
            color: #d4af37;
            font-size: 0.9rem;
            font-weight: bold;
            text-align: center;
        }

        .top-note-dropdown {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #d4af37;
            border-radius: 6px;
            background: rgba(212, 175, 55, 0.1);
            color: #d4af37;
            font-weight: bold;
            font-size: 1.1rem;
            text-align: center;
        }

        .top-note-dropdown option {
            background: #1a1a2e;
            color: #d4af37;
        }

        .nav-arrow {
            background: rgba(168, 200, 236, 0.2);
            border: 2px solid #a8c8ec;
            color: #a8c8ec;
            padding: 0.8rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-arrow:hover {
            background: rgba(168, 200, 236, 0.4);
            transform: scale(1.1);
        }

        .nav-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .voicing-navigation-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .voicing-counter {
            color: #f4f4f4;
            font-size: 0.8rem;
            min-width: 50px;
            text-align: center;
        }


        .selected-voicing {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1.2rem;
            font-family: 'Courier New', monospace;
            font-size: 1.4rem;
            line-height: 1.5;
            text-align: center;
            white-space: pre-line;
            font-weight: bold;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 200px;
        }

        .voicing-with-positions {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .voice-position {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            margin: 0.2rem 0;
            height: 2rem;
        }

        .voice-note {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .voice-position.top-note .voice-note {
            color: #d4af37;
        }

        .voicing-scale-name {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            font-weight: normal;
            font-family: 'Georgia', serif;
            margin-top: 1rem;
            font-style: italic;
            height: 2.5rem;
            overflow: hidden;
            line-height: 1.2;
            display: flex;
            align-items: flex-end;
        }

        .empty-progression {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.2rem;
            margin-top: 3rem;
        }

        .top-note-line {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .top-note-line h3 {
            color: #ffd700;
            margin-bottom: 1rem;
        }

        .top-note-sequence {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            color: #4ecdc4;
            letter-spacing: 2px;
        }

        @media (max-width: 1200px) {
            .progression-creator {
                grid-template-columns: minmax(260px, 300px) 1fr;
                gap: 1rem;
            }
        }

        @media (max-width: 768px) {
            .progression-creator {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .controls-panel {
                padding: 1rem;
            }
            
            .progression-area {
                padding: 1rem;
            }
            
            .progression-controls {
                flex-direction: column;
                gap: 0.8rem;
                align-items: stretch;
            }
            
            .control-group {
                justify-content: center;
            }
            
            .primary-actions {
                flex: none;
            }
            
            .history-actions {
                justify-content: center;
            }
            
            .chord-slot {
                min-width: 160px;
                max-width: 200px;
                height: 540px;
            }
        }

        /* Progression Library (Raw) Styles */
        .progressions-library {
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .progression-selector {
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progression-selector label {
            font-weight: bold;
            color: #8B7D6B;
        }

        .progression-selector select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: #E8E3D3;
            font-size: 1rem;
            min-width: 150px;
        }

        .library-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .top-note-line-nav {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(212, 175, 55, 0.2);
            height: fit-content;
            position: sticky;
            top: 1rem;
        }

        .top-note-line-nav h3 {
            color: #d4af37;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            text-align: center;
        }

        .nav-controls {
            margin-bottom: 1rem;
        }
        
        .filter-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(212, 175, 55, 0.25);
            color: #B8B3A8;
            border-radius: 8px;
            padding: 0.5rem 0.85rem;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filter-btn:hover {
            background: rgba(212, 175, 55, 0.15);
            border-color: rgba(212, 175, 55, 0.4);
            color: #d4af37;
            transform: translateY(-1px);
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #d4af37, #b8941f);
            border-color: #d4af37;
            color: #2c3e50;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
        }
        
        .interval-header {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.08));
            border: 1px solid rgba(212, 175, 55, 0.25);
            border-radius: 10px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .interval-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #d4af37;
            margin: 0;
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .interval-summary {
            background: rgba(212, 175, 55, 0.2);
            color: #f5f5f5;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }
        
        .progression-title {
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.9), rgba(52, 73, 94, 0.8));
            color: #ecf0f1;
            padding: 0.75rem 1.2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 1rem;
            border: 1px solid rgba(212, 175, 55, 0.2);
            text-transform: capitalize;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .default-message {
            text-align: center;
            padding: 3rem 2rem;
            color: #B8B3A8;
        }
        
        .default-message h3 {
            color: #d4af37;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .default-message p {
            color: #A0A0A0;
            font-size: 1.1rem;
        }

        .search-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 6px;
            padding: 0.6rem 1rem;
            color: #E8E3D3;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }

        .search-input::placeholder {
            color: #8B7D6B;
        }

        .sort-controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .sort-label {
            font-size: 0.8rem;
            color: #F5F5DC;
            opacity: 0.8;
        }

        .sort-switch {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 2px;
            position: relative;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .sort-switch input[type="radio"] {
            display: none;
        }

        .sort-switch label {
            flex: 1;
            padding: 0.4rem 0.8rem;
            font-size: 0.7rem;
            color: #F5F5DC;
            text-align: center;
            cursor: pointer;
            border-radius: 18px;
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
            opacity: 0.7;
        }

        .sort-switch input[type="radio"]:checked + label {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.8), rgba(212, 175, 55, 0.6));
            color: #1a1a1a;
            font-weight: 600;
            opacity: 1;
            box-shadow: 0 2px 4px rgba(212, 175, 55, 0.3);
        }

        .sort-switch label:hover {
            opacity: 1;
        }

        .nav-btn {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 6px;
            padding: 0.6rem 1rem;
            color: #E8E3D3;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }

        .nav-btn.active {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
            color: #d4af37;
            font-weight: bold;
        }

        .top-note-line-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.1);
        }

        .top-note-line-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .top-note-line-item:last-child {
            border-bottom: none;
        }

        .top-note-line-item:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #d4af37;
        }

        .top-note-line-item.active {
            background: rgba(212, 175, 55, 0.15);
            border-color: #d4af37;
        }

        .top-note-line-name {
            font-weight: bold;
            color: #d4af37;
            font-family: 'Courier New', monospace;
        }

        .top-note-line-count {
            font-size: 0.8rem;
            color: #A0A0A0;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
        }

        .top-note-line-browser {
            min-height: 500px;
        }

        .top-note-line-browser h3 {
            color: #d4af37;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }

        @media (max-width: 1024px) {
            .library-layout {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .top-note-line-nav {
                position: static;
            }
            
            .top-note-line-list {
                max-height: 200px;
            }
        }

        .top-note-line-group {
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .top-note-line-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
        }

        .top-note-line-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #d4af37;
        }

        .top-note-line-description {
            color: #A0A0A0;
            font-size: 0.9rem;
        }

        .progression-variations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1rem;
        }

        .progression-variation {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s ease;
        }

        .progression-variation:hover {
            border-color: #d4af37;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
        }

        .progression-variation.touch-active {
            border-color: #d4af37;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
        }

        .library-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(212, 175, 55, 0.9);
            color: #1a1a1a;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .library-indicator::before {
            content: '📚';
            font-size: 0.8em;
        }

        .library-indicator:hover {
            background: rgba(212, 175, 55, 1);
            transform: scale(1.05);
            transition: all 0.2s ease;
        }

        /* Enhanced tooltip styling for library indicator */
        .library-indicator[title] {
            cursor: help;
        }

        .progression-number {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(128, 128, 128, 0.7);
            color: #ffffff;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 500;
            z-index: 99;
        }

        .progression-variation {
            position: relative;
        }

        .progression-actions {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 10;
        }

        .save-progression-btn {
            background: linear-gradient(135deg, #d4af37, #ff6b6b);
            border: none;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.3);
            position: relative;
            z-index: 15;
        }

        .save-progression-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.4);
        }

        .variation-header {
            margin-bottom: 1rem;
            text-align: center;
        }

        .variation-scales {
            font-size: 0.85rem;
            color: #A0A0A0;
        }

        .library-progression-display {
            display: flex;
            align-items: stretch;
            gap: 1rem;
        }

        .library-chord {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chord-header {
            background: rgba(212, 175, 55, 0.15);
            padding: 0.5rem 1rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chord-symbol {
            font-weight: bold;
            color: #d4af37;
            font-size: 1.1rem;
        }

        .voicing-display {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .voicing-content {
            font-family: 'Courier New', monospace;
            font-size: 2.2rem;
            font-weight: bold;
            line-height: 1.4;
            color: #F5F5DC;
            background: rgba(0, 0, 0, 0.3);
            padding: 1.2rem;
            border-radius: 4px;
            white-space: pre-line;
            text-align: center;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .scale-indicator {
            font-size: 0.7rem;
            color: #8B7D6B;
            text-align: center;
            margin-top: 0.5rem;
            opacity: 0.7;
        }

        .voice-leading-connector {
            width: 80px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            position: relative;
            flex-shrink: 0;
            margin-top: 0;
        }

        .voice-leading-connector.library {
            margin-top: -9rem;
            z-index: 1;
            max-height: 8rem;
            overflow: visible;
            pointer-events: none;
        }

        .voice-leading-connector.library .connector-indicators {
            gap: 1rem;
        }

        .connector-lines {
            position: relative;
            width: 100%;
            height: 140px;
            background: rgba(45, 45, 60, 0.3);
            border-radius: 4px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .connector-indicators {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.3rem;
            background: rgba(45, 45, 60, 0.3);
            border-radius: 4px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            min-height: fit-content;
        }

        .voice-line {
            position: absolute;
            left: 10px;
            right: 10px;
            height: 3px;
            border-radius: 2px;
            box-shadow: 0 0 4px rgba(0,0,0,0.3);
        }

        .voice-line.common-tone {
            background: #22c55e;
        }

        .voice-line.step-motion {
            background: #3b82f6;
        }

        .voice-line.leap-motion {
            background: #f59e0b;
        }

        .movement-summary {
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            border: 1px solid rgba(212, 175, 55, 0.1);
        }

        .movement-counts {
            display: flex;
            gap: 0.3rem;
            justify-content: center;
        }

        .count {
            padding: 0.3rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .count.common-tone {
            background: rgba(34, 197, 94, 0.2);
            color: #34d568;
        }

        .count.step-motion {
            background: rgba(59, 130, 246, 0.2);
            color: #5593ff;
        }

        .count.total-semitones {
            background: rgba(139, 92, 246, 0.2);
            color: #a177ff;
        }

        .count.leap-motion {
            background: rgba(245, 158, 11, 0.2);
            color: #ffb347;
        }

        @media (max-width: 768px) {
            .progression-variations {
                grid-template-columns: 1fr;
            }
            
            .library-progression-display {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .chord-separator {
                transform: rotate(90deg);
                font-size: 1.2rem;
            }
        }

        /* Progression Library (JSON Files) Styles */
        .progression-files {
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .loading-message {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            padding: 2rem;
        }

        .progression-files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .progression-file-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .progression-file-item:hover {
            transform: translateY(-2px);
            border-color: rgba(212, 175, 55, 0.4);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .progression-file-header {
            background: rgba(212, 175, 55, 0.15);
            padding: 1rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .progression-file-name {
            font-weight: bold;
            color: #d4af37;
            font-size: 0.9rem;
        }

        .progression-file-content {
            padding: 1rem;
        }

        .progression-file-chords {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .chord-info {
            flex: 1;
            text-align: center;
        }

        .chord-symbol {
            font-size: 1.2rem;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 0.5rem;
        }

        .chord-details {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .scale-name {
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .top-note {
            color: rgba(255, 255, 255, 0.5);
        }

        .voice-leading-arrow {
            font-size: 1.5rem;
            color: #d4af37;
            font-weight: bold;
        }

        .voice-leading-analysis {
            text-align: center;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .progression-file-actions {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .load-progression-btn {
            background: rgba(212, 175, 55, 0.6);
            color: #e8e8e8;
            border: 1px solid rgba(212, 175, 55, 0.3);
            padding: 0.4rem 1rem;
            border-radius: 6px;
            font-weight: normal;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .load-progression-btn:hover {
            background: rgba(212, 175, 55, 0.8);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.2);
        }

        @media (max-width: 768px) {
            .progression-files-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .progression-file-chords {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .voice-leading-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Jazz Piano Voicings</h1>
        
        <div class="mode-toggle">
            <button class="mode-btn" onclick="switchMode('progression-library')">Progression Library</button>
            <button class="mode-btn" onclick="switchMode('progression')">Create Progression</button>
            <button class="mode-btn" onclick="switchMode('browse')">Browse Voicings</button>
            <button class="mode-btn" onclick="switchMode('progressions-library')">Progression Library (Raw)</button>
        </div>

        <!-- Browse Mode -->
        <div id="browse-mode" class="mode-section">
            <!-- Chord Type Navigation Panel -->
            <div id="chord-type-nav" class="chord-type-navigation">
                <div class="nav-toggle" onclick="toggleNavigation()">−</div>
                <div class="nav-title">Chord Types</div>
                <div class="nav-items">
                    <a href="#major-chords" class="nav-item" data-chord-type="major">Major</a>
                    <a href="#minor-chords" class="nav-item" data-chord-type="minor">Minor</a>
                    <a href="#dominant-chords" class="nav-item" data-chord-type="dominant">Dominant</a>
                    <a href="#sus-chords" class="nav-item" data-chord-type="sus">Sus</a>
                    <a href="#half-diminished-chords" class="nav-item" data-chord-type="half-diminished">Half-Dim</a>
                    <a href="#diminished-chords" class="nav-item" data-chord-type="diminished">Diminished</a>
                </div>
            </div>
            <div id="browse-content">
                <!-- Content will be dynamically loaded -->
            </div>
        </div>

        <!-- Progressions Library Mode -->
        <div id="progressions-library-mode" class="mode-section">
            <div class="progressions-library">
                <h2>Progression Library (Raw)</h2>
                <div class="progression-selector">
                    <label for="progression-type">Progression Type:</label>
                    <select id="progression-type" onchange="loadProgressionType()">
                        <option value="V7-I">V7 - I (major)</option>
                        <option value="V7-i">V7 - i (minor)</option>
                    </select>
                </div>
                
                <div class="library-layout">
                    <div class="top-note-line-nav">
                        <h3>Top-Note-Lines</h3>
                        <div class="nav-controls">
                            <input type="text" id="search-input" class="search-input" placeholder="Search top-note-lines..." oninput="filterTopNoteLines()">
                            <div class="sort-controls">
                                <span class="sort-label">Sort by:</span>
                                <div class="sort-switch">
                                    <input type="radio" id="sort-closeness" name="sort-method" value="closeness" checked onchange="refreshNavigation()">
                                    <label for="sort-closeness">Interval Closeness</label>
                                    <input type="radio" id="sort-count" name="sort-method" value="count" onchange="refreshNavigation()">
                                    <label for="sort-count">Progression Count</label>
                                </div>
                            </div>
                        </div>
                        <div id="top-note-line-list" class="top-note-line-list">
                            <!-- Navigation will be dynamically loaded -->
                        </div>
                    </div>
                    
                    <div class="top-note-line-browser">
                        <h3 id="current-filter-title">All Top-Note-Lines</h3>
                        <div id="progression-library-content">
                            <!-- Content will be dynamically loaded -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progression Library Mode -->
        <div id="progression-library-mode" class="mode-section active">
            <div class="progressions-library">
                <h2>Progression Library</h2>
                <div class="progression-selector">
                    <label for="progression-type-files">Progression Type:</label>
                    <select id="progression-type-files" onchange="loadProgressionTypeFiles()">
                        <option value="V7-I">V7 - I (major)</option>
                    </select>
                </div>
                
                <div class="library-layout">
                    <div class="top-note-line-nav">
                        <h3>Top-Note-Lines</h3>
                        <div class="nav-controls">
                            <input type="text" id="search-input-files" class="search-input" placeholder="Search top-note-lines..." oninput="filterTopNoteLinesFiles()">
                        </div>
                        <div id="top-note-lines-files" class="top-note-lines-content"></div>
                    </div>
                    
                    <div class="progressions-content">
                        <div class="default-message">
                            <h3 id="current-filter-title-files">All Top-Note-Lines</h3>
                            <p>Select a top-note-line from the left panel to view progressions.</p>
                        </div>
                        <div id="progressions-content-files"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progression Creator Mode -->
        <div id="progression-mode" class="mode-section">
            <div class="progression-creator">
                <div class="controls-panel">
                    <div class="chord-bank">
                        <div class="root-selection" id="root-selection">
                            <div class="root-options" id="root-options">
                                <!-- Degree options will be populated -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="progression-area" id="progression-area">
                    <div class="progression-header">
                        <h2>Your Progression</h2>
                        <div class="progression-controls">
                            <div class="control-group history-actions">
                                <button class="undo-btn" onclick="undoAction()" disabled>↶</button>
                                <button class="redo-btn" onclick="redoAction()" disabled>↷</button>
                            </div>
                            <div class="control-group primary-actions">
                                <button class="save-btn" onclick="saveProgression()">💾 Save</button>
                                <button class="load-btn" onclick="loadProgression()">📁 Load</button>
                                <button class="clear-btn" onclick="clearProgression()">🗑️ Clear All</button>
                            </div>
                            <input type="file" id="file-input" accept=".json" style="display: none;" onchange="handleFileLoad(event)">
                        </div>
                    </div>
                    <div class="progression-container" id="progression-container">
                        <div class="empty-progression">
                            Click any Roman numeral degree to add it to your progression
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Complete Pentatonic Voicing Data - ALL 131+ voicings from CSV files
        const voicingData = {
  major: {
    "Pentatonic": {
      1: ["1", "5", "9", "", "13", "3"],
      3: ["3", "1", "5", "", "9", "13"],
      5: ["5", "9", "13", "", "3", "1"],
      9: ["9", "13", "3", "", "1", "5"],
      13: ["13", "3", "1", "", "5", "9"]
    },
    "Pentatonic (from 5)": {
      3: ["3", "7", "5", "", "9", "13"],
      5: ["5", "9", "13", "", "3", "7"],
      7: ["7", "5", "9", "", "13", "3"],
      9: ["9", "13", "3", "", "7", "5"],
      13: ["13", "3", "7", "", "5", "9"]
    },
    "Pentatonic (from 2)": {
      3: ["3", "7", "♯11", "", "9", "13"],
      7: ["7", "♯11", "9", "", "13", "3"],
      9: ["9", "13", "3", "", "7", "♯11"],
      "♯11": ["♯11", "9", "13", "", "3", "7"],
      13: ["13", "3", "7", "", "♯11", "9"]
    },
    "Pentatonic \"major 7\"": {
      5: ["5", "9", "7", "", "3", "1"],
      9: ["9", "7", "3", "", "1", "5"]
    },
    "Pentatonic \"minor 7\" (from 6)": {
      13: ["13", "3", "7", "", "5", "1"]
    }
  },

  minor: {
    "Pentatonic ♭3": {
      1: ["1", "5", "9", "", "13", "3"],
      5: ["5", "9", "13", "", "3", "1"],
      9: ["9", "13", "3", "", "1", "5"]
    },
    "Pentatonic (from 3)": {
      1: ["1", "5", "3", "", "7", "11"],
      3: ["3", "7", "11", "", "1", "5"],
      5: ["5", "3", "7", "", "11", "1"],
      7: ["7", "11", "1", "", "5", "3"],
      11: ["11", "1", "5", "", "3", "7"]
    },
    "Pentatonic \"minor 7\"": {
      1: ["1", "5", "9", "", "7", "3"],
      5: ["5", "9", "7", "", "3", "1"],
      9: ["9", "7", "3", "", "1", "5"]
    },
    "Pentatonic \"major 7\" (from 3)": {
      7: ["7", "11", "9", "", "5", "3"],
      11: ["11", "9", "5", "", "3", "7"]
    },
    "Pentatonic \"dorian\"": {
      1: ["1", "13", "3", "", "7", "5"],
      5: ["5", "1", "13", "", "3", "7"],
      13: ["13", "3", "7", "", "5", "1"]
    },
    "Pentatonic ♭6 (from 5)": {
      "♮7": ["♮7", "5", "9", "", "13", "3"],
      9: ["9", "13", "3", "", "♮7", "5"]
    },
    "Pentatonic \"minor-major 7\"": {
      5: ["5", "9", "♮7", "", "3", "1"],
      9: ["9", "♮7", "3", "", "1", "5"]
    }
  },

  dominant: {
    "Pentatonic \"dominant\"": {
      1: ["1", "5", "9", "", "7", "3"],
      3: ["3", "1", "5", "", "9", "7"],
      5: ["5", "9", "7", "", "3", "1"],
      7: ["7", "3", "1", "", "5", "9"],
      9: ["9", "7", "3", "", "1", "5"]
    },
    "Pentatonic \"dominant 1-3-5-6-7\"": {
      1: ["1", "13", "3", "", "7", "5"],
      5: ["5", "1", "13", "", "3", "7"],
      13: ["13", "3", "7", "", "5", "1"]
    },
    "Pentatonic ♭3 (from 5)": {
      5: ["5", "9", "13", "", "3", "7"],
      9: ["9", "13", "3", "", "7", "5"],
      13: ["13", "3", "7", "", "5", "9"]
    },
    "Pentatonic \"phrygian steps\" (from 6)": {
      1: ["1", "13", "9", "", "7", "3"],
      3: ["3", "1", "13", "", "9", "7"],
      13: ["13", "9", "7", "", "3", "1"]
    },
    "Pentatonic \"phrygian steps\" ♭4 (from 6)": {
      1: ["1", "13", "♭9", "", "7", "3"],
      3: ["3", "1", "13", "", "♭9", "7"],
      13: ["13", "♭9", "7", "", "3", "1"]
    },
    "Pentatonic \"dominant\" ♭2 (♭9)": {
      1: ["1", "5", "♭9", "", "7", "3"],
      3: ["3", "1", "5", "", "♭9", "7"],
      5: ["5", "♭9", "7", "", "3", "1"],
      7: ["7", "3", "1", "", "5", "♭9"],
      "♭9": ["♭9", "7", "3", "", "1", "5"]
    },
    "Pentatonic \"dominant\" ♯2 (♯9)": {
      1: ["1", "5", "♯9", "", "7", "3"],
      5: ["5", "♯9", "7", "", "3", "1"],
      "♯9": ["♯9", "7", "3", "", "1", "5"]
    },
    "Pentatonic \"dominant\" ♭2 (from 6)": {
      5: ["5", "♭9", "13", "", "3", "7"],
      "♭9": ["♭9", "13", "3", "", "7", "5"],
      13: ["13", "3", "7", "", "5", "♭9"]
    },
    "Pentatonic \"dominant\" ♭2 (from ♭3)": {
      5: ["5", "♯9", "7", "", "3", "♭9"],
      "♭9": ["♭9", "5", "♯9", "", "7", "3"],
      "♯9": ["♯9", "7", "♭9", "", "♭9", "5"]
    },
    "Pentatonic \"dominant\" ♭2, ♭5": {
      1: ["1", "♯11", "♭9", "", "7", "3"],
      3: ["3", "1", "♯11", "", "♭9", "7"],
      7: ["7", "3", "1", "", "♯11", "♭9"],
      "♭9": ["♭9", "7", "3", "", "1", "♯11"],
      "♯11": ["♯11", "♭9", "7", "", "3", "1"]
    },
    "Pentatonic \"dominant\" ♭2, ♯5": {
      1: ["1", "♭13", "♭9", "", "7", "3"],
      3: ["3", "1", "♭13", "", "♭9", "7"],
      7: ["7", "3", "1", "", "♭13", "♭9"],
      "♭9": ["♭9", "7", "3", "", "1", "♭13"],
      "♭13": ["♭13", "♭9", "7", "", "3", "1"]
    },
    "Pentatonic \"dominant\" ♯2, ♭5": {
      1: ["1", "♯11", "♯9", "", "7", "3"],
      "♯9": ["♯9", "7", "3", "", "1", "♯11"],
      "♯11": ["♯11", "♯9", "7", "", "3", "1"]
    },
    "Pentatonic \"dominant\" ♯2, ♯5": {
      1: ["1", "♭13", "♯9", "", "7", "3"],
      "♯9": ["♯9", "7", "3", "", "1", "♭13"],
      "♭13": ["♭13", "♯9", "7", "", "3", "1"]
    },
    "Pentatonic ♭6 (from 2)": {
      9: ["9", "13", "3", "", "7", "♯11"],
      "♯11": ["♯11", "9", "13", "", "3", "7"],
      13: ["13", "3", "7", "", "♯11", "9"]
    },
    "Pentatonic \"minor-major 7\" (from 5)": {
      9: ["9", "13", "♯11", "", "7", "5"],
      13: ["13", "♯11", "7", "", "5", "9"]
    },
    "Pentatonic \"diminished steps\"": {
      3: ["3", "13", "♯11", "", "7", "5"],
      13: ["13", "9", "7", "", "5", "3"]
    },
    "WT (from 2)": {
      3: ["3", "7", "♯11", "", "9", "♭13"],
      7: ["7", "♯11", "9", "", "♭13", "3"],
      9: ["9", "♭13", "3", "", "7", "♯11"],
      "♯11": ["♯11", "9", "♭13", "", "3", "7"],
      "♭13": ["♭13", "3", "7", "", "♯11", "9"]
    },
    "WT (from 3)": {
      1: ["1", "♭13", "3", "", "7", "♯11"],
      3: ["3", "7", "♯11", "", "1", "♭13"],
      7: ["7", "♯11", "1", "", "♭13", "3"],
      "♯11": ["♯11", "1", "♭13", "", "3", "7"],
      "♭13": ["♭13", "3", "7", "", "♯11", "1"]
    },
    "WT (from ♭6)": {
      1: ["1", "♭13", "9", "", "7", "3"],
      3: ["3", "1", "♭13", "", "9", "7"],
      7: ["7", "3", "1", "", "♭13", "9"],
      9: ["9", "7", "3", "", "1", "♭13"],
      "♭13": ["♭13", "9", "7", "", "3", "1"]
    },
    "WT (from 7)": {
      1: ["1", "♯11", "9", "", "7", "3"],
      3: ["3", "1", "♯11", "", "9", "7"],
      9: ["9", "7", "3", "", "1", "♯11"],
      "♯11": ["♯11", "9", "7", "", "3", "1"]
    },
    "Pentatonic \"dominant\" (from ♭5)": {
      3: ["3", "7", "♯11", "", "♭9", "♭13"],
      7: ["7", "♯11", "♭9", "", "♭13", "3"],
      "♭9": ["♭9", "♭13", "3", "", "7", "♯11"],
      "♯11": ["♯11", "♭9", "♭13", "", "3", "7"],
      "♭13": ["♭13", "3", "7", "", "♯11", "♭9"]
    },
    "Pentatonic \"dominant\" ♭2 (from ♭5)": {
      "♭9": ["♭9", "13", "3", "", "7", "♯11"],
      "♯11": ["♯11", "♭9", "13", "", "3", "7"],
      13: ["13", "3", "7", "", "♯11", "♭9"]
    },
    "Pentatonic \"dominant\" (from ♭5) ♯2, ♭5": {
      1: ["1", "13", "3", "", "7", "♯11"],
      "♯11": ["♯11", "1", "13", "", "3", "7"],
      13: ["13", "3", "7", "", "♯11", "1"]
    },
    "Pentatonic ♭3 (from ♭2)": {
      "♭9": ["♭9", "♭13", "♯9", "", "7", "3"],
      "♯9": ["♯9", "7", "3", "", "♭9", "♭13"],
      "♭13": ["♭13", "♯9", "7", "", "3", "♭9"]
    }
  },

  sus: {
    "Pentatonic (from 7)": {
      1: ["1", "5", "9", "", "7", "4"],
      4: ["4", "1", "5", "", "9", "7"],
      5: ["5", "9", "7", "", "4", "1"],
      7: ["7", "4", "1", "", "5", "9"],
      9: ["9", "7", "4", "", "1", "5"]
    },
    "Pentatonic \"major 7\" (from 7)": {
      1: ["1", "13", "9", "", "7", "4"],
      4: ["4", "1", "13", "", "9", "7"],
      13: ["13", "9", "7", "", "4", "1"]
    },
    "Pentatonic \"minor 7\" (from 5)": {
      5: ["5", "9", "13", "", "4", "7"],
      9: ["9", "13", "4", "", "7", "5"],
      13: ["13", "4", "7", "", "5", "9"]
    },
    "Pentatonic ♭3 (from 7)": {
      1: ["1", "5", "♭9", "", "7", "4"],
      4: ["4", "1", "5", "", "♭9", "7"],
      5: ["5", "♭9", "7", "", "4", "1"],
      7: ["7", "4", "1", "", "5", "♭9"],
      "♭9": ["♭9", "7", "4", "", "1", "5"]
    },
    "Pentatonic \"minor 7\" (from 7)": {
      1: ["1", "♭13", "♭9", "", "7", "4"],
      4: ["4", "1", "♭13", "", "♭9", "7"],
      7: ["7", "4", "1", "", "♭13", "♭9"],
      "♭9": ["♭9", "7", "4", "", "1", "♭13"],
      "♭13": ["♭13", "♭9", "7", "", "4", "1"]
    },
    "Pentatonic \"dorian\" (from 7)": {
      4: ["4", "7", "5", "", "♭9", "♭13"],
      5: ["5", "♭9", "♭13", "", "4", "7"],
      7: ["7", "5", "♭9", "", "♭13", "4"]
    },
    "Pentatonic (from ♭2)": {
      4: ["4", "♭9", "♭13", "", "♯9", "7"],
      7: ["7", "4", "♭9", "", "♭13", "♯9"],
      "♭9": ["♭9", "♭13", "♯9", "", "7", "4"],
      "♯9": ["♯9", "7", "4", "", "♭9", "♭13"],
      "♭13": ["♭13", "♯9", "7", "", "4", "♭9"]
    }
  },

  "half-diminished": {
    "Pentatonic ♭3 (from 3)": {
      1: ["1", "5", "3", "", "7", "11"],
      3: ["3", "7", "11", "", "1", "5"],
      5: ["5", "3", "7", "", "11", "1"],
      7: ["7", "11", "1", "", "5", "3"],
      11: ["11", "1", "5", "", "3", "7"]
    },
    "Pentatonic \"Super-Locrian\"": {
      1: ["1", "5", "9", "", "7", "3"],
      5: ["5", "9", "7", "", "3", "1"],
      9: ["9", "7", "3", "", "1", "5"]
    },
    "Pentatonic \"minor-major 7\" (from 3)": {
      7: ["7", "11", "9", "", "5", "3"],
      11: ["11", "9", "5", "", "3", "7"]
    },
    "Pentatonic \"diminished steps\"": {
      1: ["1", "11", "9", "", "5", "3"],
      11: ["11", "9", "5", "", "3", "1"]
    },
    "Pentatonic ♭6 (from 7)": {
      9: ["9", "7", "11", "", "1", "5"],
      11: ["11", "1", "5", "", "9", "7"]
    }
  },

  diminished: {
    "Pentatonic \"dim-maj7\"": {
      5: ["5", "9", "maj7", "", "3", "1"],
      9: ["9", "maj7", "3", "", "1", "5"]
    },
    "Pentatonic \"dim-maj7\" (from 3)": {
      7: ["7", "11", "9", "", "5", "3"],
      11: ["11", "9", "5", "", "3", "7"]
    },
    "Pentatonic \"dim-maj7\" (from 5)": {
      1: ["1", "13", "11", "", "7", "5"],
      13: ["13", "11", "7", "", "5", "1"]
    },
    "Pentatonic \"dim-maj7\" (from 7)": {
      3: ["3", "maj7", "13", "", "1", "7"],
      "maj7": ["maj7", "13", "1", "", "7", "3"]
    },
    "Pentatonic \"Dominant\" ♭2 (from 2)": {
      1: ["1", "5", "9", "", "7", "3"],
      5: ["5", "9", "7", "", "3", "1"],
      9: ["9", "7", "3", "", "1", "5"]
    },
    "Pentatonic \"Dominant\" ♯2 (from 2)": {
      1: ["1", "5", "9", "", "7", "3"],
      9: ["9", "7", "11", "", "1", "5"]
    },
    "Pentatonic \"Dominant\" ♭2 (from 4)": {
      3: ["3", "7", "11", "", "1", "5"],
      7: ["7", "11", "1", "", "5", "3"],
      11: ["11", "1", "5", "", "7", "3"]
    },
    "Pentatonic \"Dominant\" ♭2 (from 6)": {
      1: ["1", "13", "3", "", "7", "5"],
      5: ["5", "1", "13", "", "3", "7"],
      13: ["13", "3", "7", "", "5", "1"]
    },
    "Pentatonic \"Dominant\" ♭2 (from maj7)": {
      3: ["3", "maj7", "5", "", "1", "7"],
      7: ["7", "3", "maj7", "", "5", "1"],
      "maj7": ["maj7", "5", "1", "", "7", "3"]
    }
  }
};

        // Note-to-semitone conversion system for voice leading analysis
        const noteToSemitones = {
            // Basic chord tones and extensions
            '1': 0, 'b2': 1, '2': 2, 'b3': 3, '3': 4, '4': 5, 'b5': 6, '5': 7, 
            '#5': 8, 'b6': 8, '6': 9, 'bb7': 9, 'b7': 10, '♮7': 11, '7': 11,
            '8': 12, 'b9': 13, '9': 14, '#9': 15, '10': 16, '11': 17, '#11': 18, 'b13': 20, '13': 21,
            
            // Jazz notation variants
            '♭2': 1, '♭3': 3, '♭5': 6, '♯5': 8, '♭6': 8, '♭♭7': 9, '♭7': 10,
            '♭9': 13, '♯9': 15, '♯11': 18, '♭13': 20
        };

        function getNoteInSemitones(note, chordType) {
            if (!note || note === '') return null;
            
            // Handle special cases and normalize notation
            let normalizedNote = note.toString().trim();
            
            // Convert various notations to standard
            // Note: Keep ♮7 separate from 7 for proper minor chord analysis
            
            // Get base semitone value
            const semitones = noteToSemitones[normalizedNote];
            if (semitones !== undefined) return semitones;
            
            // Fallback for unknown notes
            console.warn(`Unknown note: ${note}`);
            return null;
        }

        // Voice Leading Analysis Functions
        function analyzeVoiceLeading(chord1, chord2) {
            if (!chord1.selectedVoicing || !chord2.selectedVoicing) return null;
            
            const voicing1 = chord1.selectedVoicing.split('\n');
            const voicing2 = chord2.selectedVoicing.split('\n');
            
            const chord1Type = getChordType(chord1.symbol);
            const chord2Type = getChordType(chord2.symbol);
            
            const movements = [];
            
            // Analyze each voice position including gaps
            for (let i = 0; i < Math.max(voicing1.length, voicing2.length); i++) {
                const note1 = voicing1[i];
                const note2 = voicing2[i];
                
                // Only analyze if both notes exist and are not empty
                if (note1 && note2 && note1.trim() !== '' && note2.trim() !== '') {
                    const movement = calculateVoiceMovement(note1, note2, chord1.symbol, chord1Type, chord2.symbol, chord2Type);
                    movements.push({
                        position: i,
                        from: note1,
                        to: note2,
                        ...movement
                    });
                }
            }
            
            return movements;
        }
        
        function getActualPitchInSemitones(chordDegree, chordSymbol, chordType) {
            // Get the root note offset for the chord symbol
            const rootOffset = getChordRootOffset(chordSymbol);
            let degreeOffset = getNoteInSemitones(chordDegree, chordType);
            
            if (rootOffset === null || degreeOffset === null) return null;
            
            // The chord degree already includes alterations (♭9, ♯11, etc.)
            // But we need to apply basic chord type modifications to unaltered degrees
            if (chordType === 'minor' && chordDegree === '3') {
                degreeOffset = 3; // ♭3
            } else if (chordType === 'minor' && chordDegree === '7') {
                degreeOffset = 10; // ♭7
            } else if ((chordType === 'dominant' || chordType === 'sus') && chordDegree === '7') {
                degreeOffset = 10; // ♭7
            }
            
            return (rootOffset + degreeOffset) % 12;
        }
        
        function getChordRootOffset(chordSymbol) {
            // Map Roman numeral to semitone offset from tonic
            // Assuming major key context for now
            const romanToSemitones = {
                'I': 0, 'i': 0,
                '♭II7': 1, '♭ii': 1,
                'ii': 2, 'II': 2,
                '♭III': 3, '♭iii': 3,
                'iii': 4, 'III': 4,
                'IV': 5, 'iv': 5,
                'Vsus': 7, 'V7': 7, 'V': 7,
                '♭VI': 8, '♭vi': 8,
                'vi': 9, 'VI': 9,
                '♭VII': 10, '♭vii': 10
            };
            
            // Handle secondary dominants
            if (chordSymbol.includes('/')) {
                const [chordPart, targetPart] = chordSymbol.split('/');
                const targetOffset = romanToSemitones[targetPart] || 0;
                
                // Dominant is 5 semitones above target
                if (chordPart.includes('V7') || chordPart.includes('Vsus')) {
                    return (targetOffset + 7) % 12;
                }
            }
            
            return romanToSemitones[chordSymbol] || 0;
        }

        function calculateVoiceMovement(note1, note2, chord1Symbol, chord1Type, chord2Symbol, chord2Type) {
            const pitch1 = getActualPitchInSemitones(note1, chord1Symbol, chord1Type);
            const pitch2 = getActualPitchInSemitones(note2, chord2Symbol, chord2Type);
            
            if (pitch1 === null || pitch2 === null) {
                return { interval: null, direction: 'unknown', type: 'unknown' };
            }
            
            // Special cases for classic voice leading resolutions (V7 to I context)
            if (chord1Symbol === 'V7' && (chord2Symbol === 'I' || chord2Symbol === 'i')) {
                // ♯9 (V7) resolves up by semitone to natural 7 (I)
                if (note1 === '♯9' && note2 === '7') {
                    return {
                        interval: 1,
                        direction: 'up',
                        type: 'step',
                        symbol: '↑½',
                        semitones: 1,
                        absInterval: 1
                    };
                }
                
                // 3 (V7) as leading tone resolves up by semitone to 1 (I)
                if (note1 === '3' && note2 === '1') {
                    return {
                        interval: 1,
                        direction: 'up',
                        type: 'step',
                        symbol: '↑½',
                        semitones: 1,
                        absInterval: 1
                    };
                }
                
                // ♯9 (V7) resolves up by semitone to 13 (I)
                if (note1 === '♯9' && note2 === '13') {
                    return {
                        interval: 1,
                        direction: 'up',
                        type: 'step',
                        symbol: '↑½',
                        semitones: 1,
                        absInterval: 1
                    };
                }
                
                // ♭9 (V7) resolves up by semitone to 13 (I)
                if (note1 === '♭9' && note2 === '13') {
                    return {
                        interval: 1,
                        direction: 'up',
                        type: 'step',
                        symbol: '↑½',
                        semitones: 1,
                        absInterval: 1
                    };
                }
                
                // ♭9 (V7) resolves up by semitone to 7 (I)
                if (note1 === '♭9' && note2 === '7') {
                    return {
                        interval: 1,
                        direction: 'up',
                        type: 'step',
                        symbol: '↑½',
                        semitones: 1,
                        absInterval: 1
                    };
                }
                
                // 9 (V7) resolves up by whole tone to 1 (I) 
                if (note1 === '9' && note2 === '1') {
                    console.log('DEBUG: Matched 9 → 1 special case in main function');
                    return {
                        interval: 2,
                        direction: 'up',
                        type: 'step',
                        symbol: '↑1',
                        semitones: 2,
                        absInterval: 2
                    };
                }
                
                // 9 (V7) resolves down to 5 (I) - actually a compound movement that should show as ↑1
                if (note1 === '9' && note2 === '5') {
                    console.log('DEBUG: Matched 9 → 5 special case in main function');
                    return {
                        interval: 2,
                        direction: 'up',
                        type: 'step', 
                        symbol: '↑1',
                        semitones: 2,
                        absInterval: 2
                    };
                }
                
                // 9 (V7) resolves down to 7 (I) - should show as ↑1 not ↓½  
                if (note1 === '9' && note2 === '7') {
                    console.log('DEBUG: Matched 9 → 7 special case in main function');
                    return {
                        interval: 2,
                        direction: 'up',
                        type: 'step',
                        symbol: '↑1',
                        semitones: 2,
                        absInterval: 2
                    };
                }
            }
            
            // Calculate raw interval
            let rawInterval = pitch2 - pitch1;
            
            // Calculate the shortest path (considering octave equivalence)
            let interval = rawInterval;
            if (interval > 6) {
                interval = interval - 12; // Go down instead of up
            } else if (interval < -6) {
                interval = interval + 12; // Go up instead of down
            }
            
            const direction = interval === 0 ? 'same' : interval > 0 ? 'up' : 'down';
            const absInterval = Math.abs(interval);
            
            let type, symbol;
            if (interval === 0) {
                type = 'common';
                symbol = '=';
            } else if (absInterval <= 2) {
                // 1-2 semitones = ½-1 semitone steps (blue)
                type = 'step';
                if (absInterval === 1) {
                    symbol = direction === 'up' ? '↑½' : '↓½';
                } else {
                    symbol = direction === 'up' ? '↑1' : '↓1';
                }
            } else {
                // >2 semitones = >1 semitone leaps (orange)
                type = 'leap';
                const semitoneCount = absInterval % 2 === 0 ? absInterval / 2 : `${Math.floor(absInterval / 2)}½`;
                symbol = direction === 'up' ? `↑${semitoneCount}` : `↓${semitoneCount}`;
            }
            
            return {
                interval,
                direction,
                type,
                symbol,
                semitones: absInterval,  // Keep semitones field for consistency
                absInterval
            };
        }
        
        function getVoiceLeadingColor(type) {
            switch (type) {
                case 'common': return '#4CAF50'; // Green for common tones
                case 'step': return '#2196F3'; // Blue for smooth steps
                case 'leap': return '#FF9800'; // Orange for leaps
                default: return '#757575'; // Gray for unknown
            }
        }
        
        function getVoiceLeadingSummary(movements) {
            if (!movements || movements.length === 0) return 'No voice leading data available';
            
            const commonTones = movements.filter(m => m.type === 'common').length;
            const stepMotions = movements.filter(m => m.type === 'step').length;
            const leaps = movements.filter(m => m.type === 'leap').length;
            
            // Calculate total semitones
            const totalSemitones = movements.reduce((sum, m) => {
                return sum + (m.semitones || m.absInterval || 0);
            }, 0);
            
            const details = movements.map(m => 
                `Voice ${m.position + 1}: ${m.from} → ${m.to} (${m.symbol})`
            ).join('\n');
            
            // Create compact summary: "4S 2L" format
            const summaryParts = [];
            if (totalSemitones > 0) summaryParts.push(`${totalSemitones}S`);
            if (leaps > 0) summaryParts.push(`${leaps}L`);
            const compactSummary = summaryParts.length > 0 ? summaryParts.join(' ') : '0S';
            
            return `Voice Leading Summary: ${compactSummary}
${commonTones} common tone${commonTones !== 1 ? 's' : ''}
${stepMotions} step motion${stepMotions !== 1 ? 's' : ''}
${leaps} leap${leaps !== 1 ? 's' : ''}

Details:
${details}`;
        }

        let currentProgression = [];
        let draggedChord = null;
        let selectedRoot = null;

        // Undo/Redo state management
        let progressionHistory = [];
        let historyIndex = -1;
        const MAX_HISTORY_SIZE = 50;
        let isRestoringFromHistory = false;

        function saveToHistory() {
            // Don't save to history if we're restoring from history
            if (isRestoringFromHistory) {
                console.log('🔄 saveToHistory: SKIPPED (restoring from history)');
                return;
            }
            
            // Add current state to history
            const progressionState = JSON.parse(JSON.stringify(currentProgression));
            
            // Remove any future history if we're not at the end
            progressionHistory = progressionHistory.slice(0, historyIndex + 1);
            
            // Push new state and increment index
            progressionHistory.push(progressionState);
            historyIndex++;
            
            console.log('💾 saveToHistory: SAVED state', {
                newIndex: historyIndex,
                chordCount: progressionState.length,
                chords: progressionState.map(c => `${c.symbol}(${c.currentTopNote})`),
                historyLength: progressionHistory.length,
                allHistory: progressionHistory.map((state, i) => 
                    `${i}: [${state.map(c => c.symbol + '(' + c.currentTopNote + ')').join(', ')}]`
                )
            });
            
            // Limit history size
            if (progressionHistory.length > MAX_HISTORY_SIZE) {
                progressionHistory.shift();
                historyIndex--;
            }
            
            updateHistoryButtons();
        }

        function undoAction() {
            console.log('⏪ undoAction: CALLED', {
                currentIndex: historyIndex,
                canUndo: historyIndex > 0,
                currentState: currentProgression.map(c => `${c.symbol}(${c.currentTopNote})`)
            });
            
            if (historyIndex > 0) {
                historyIndex--;
                const restoringState = progressionHistory[historyIndex];
                console.log('⏪ undoAction: RESTORING to index', historyIndex, {
                    chordCount: restoringState.length,
                    chords: restoringState.map(c => `${c.symbol}(${c.currentTopNote})`),
                    allHistory: progressionHistory.map((state, i) => 
                        `${i}: [${state.map(c => c.symbol + '(' + c.currentTopNote + ')').join(', ')}]${i === historyIndex ? ' ← NOW' : ''}`
                    )
                });
                
                isRestoringFromHistory = true;
                currentProgression = JSON.parse(JSON.stringify(restoringState));
                renderProgression();
                isRestoringFromHistory = false;
                updateHistoryButtons();
            }
        }

        function redoAction() {
            console.log('⏩ redoAction: CALLED', {
                currentIndex: historyIndex,
                maxIndex: progressionHistory.length - 1,
                canRedo: historyIndex < progressionHistory.length - 1,
                currentState: currentProgression.map(c => `${c.symbol}(${c.currentTopNote})`)
            });
            
            if (historyIndex < progressionHistory.length - 1) {
                historyIndex++;
                const restoringState = progressionHistory[historyIndex];
                console.log('⏩ redoAction: RESTORING to index', historyIndex, {
                    chordCount: restoringState.length,
                    chords: restoringState.map(c => `${c.symbol}(${c.currentTopNote})`)
                });
                
                isRestoringFromHistory = true;
                currentProgression = JSON.parse(JSON.stringify(restoringState));
                renderProgression();
                isRestoringFromHistory = false;
                updateHistoryButtons();
            }
        }

        function updateHistoryButtons() {
            const undoBtn = document.querySelector('.undo-btn');
            const redoBtn = document.querySelector('.redo-btn');
            
            if (undoBtn) {
                undoBtn.disabled = historyIndex <= 0;
                undoBtn.title = historyIndex <= 0 ? 'Nothing to undo' : 'Undo last action';
            }
            
            if (redoBtn) {
                redoBtn.disabled = historyIndex >= progressionHistory.length - 1;
                redoBtn.title = historyIndex >= progressionHistory.length - 1 ? 'Nothing to redo' : 'Redo last action';
            }
        }

        function switchMode(mode) {
            const modeButtons = document.querySelectorAll('.mode-btn');
            const browseMode = document.getElementById('browse-mode');
            const progressionMode = document.getElementById('progression-mode');
            const progressionsLibraryMode = document.getElementById('progressions-library-mode');
            const progressionLibraryMode = document.getElementById('progression-library-mode');

            // Save library state when leaving progression-library mode
            if (progressionLibraryMode.classList.contains('active') && mode !== 'progression-library') {
                saveLibraryPageState();
            }

            // Remove active class from all buttons and modes
            modeButtons.forEach(btn => btn.classList.remove('active'));
            browseMode.classList.remove('active');
            progressionMode.classList.remove('active');
            progressionsLibraryMode.classList.remove('active');
            progressionLibraryMode.classList.remove('active');

            if (mode === 'browse') {
                document.querySelector('.mode-btn[onclick="switchMode(\'browse\')"]').classList.add('active');
                browseMode.classList.add('active');
                loadBrowseMode();
            } else if (mode === 'progressions-library') {
                document.querySelector('.mode-btn[onclick="switchMode(\'progressions-library\')"]').classList.add('active');
                progressionsLibraryMode.classList.add('active');
                loadProgressionsLibraryMode();
            } else if (mode === 'progression-library') {
                document.querySelector('.mode-btn[onclick="switchMode(\'progression-library\')"]').classList.add('active');
                progressionLibraryMode.classList.add('active');
                loadProgressionLibraryMode();
                // Restore library state when returning
                setTimeout(() => restoreLibraryPageState(), 100);
            } else {
                document.querySelector('.mode-btn[onclick="switchMode(\'progression\')"]').classList.add('active');
                progressionMode.classList.add('active');
                loadProgressionMode();
                // Initialize history when switching to progression mode
                setTimeout(() => ensureHistoryInitialized(), 0);
            }
        }

        function loadBrowseMode() {
            const browseContent = document.getElementById('browse-content');
            let html = '';

            // Define column order for each chord type
            const topNoteColumns = {
                major: ['1', '3', '5', '7', '9', '♯11', '13'],
                minor: ['1', '3', '5', '7', '♮7', '9', '11', '13'],
                dominant: ['1', '3', '5', '7', '♭9', '9', '♯9', '♯11', '♭13', '13'],
                sus: ['1', '4', '5', '7', '♭9', '9', '♯9', '♭13', '13'],
                'half-diminished': ['1', '3', '5', '7', '9', '11'],
                'diminished': ['1', '3', '5', '7', 'maj7', '9', '11', '13']
            };


            Object.entries(voicingData).forEach(([chordType, scales]) => {
                const chordTypeTitle = chordType.charAt(0).toUpperCase() + chordType.slice(1) + ' Chords';
                const columns = topNoteColumns[chordType];
                
                // Get only columns that actually have voicings in this chord type
                const usedColumns = [];
                const allTopNotes = new Set();
                Object.values(scales).forEach(voicings => {
                    Object.keys(voicings).forEach(topNote => allTopNotes.add(topNote));
                });
                columns.forEach(col => {
                    if (allTopNotes.has(col)) {
                        usedColumns.push(col);
                    }
                });
                
                const gridCols = `repeat(${usedColumns.length}, 1fr)`;
                
                html += `
                    <div class="chord-type" id="${chordType}-chords">
                        <h2>${chordTypeTitle}</h2>
                        
                        <div class="note-headers" style="grid-template-columns: ${gridCols};">
                            ${usedColumns.map(note => `<div class="note-header">${note}</div>`).join('')}
                        </div>
                        
                        <div class="voicing-table">
                `;

                Object.entries(scales).forEach(([scaleName, voicings]) => {
                    const voicingCount = Object.keys(voicings).length;
                    html += `
                        <div class="scale-row">
                            <div class="scale-name">${scaleName}</div>
                            <div class="voicing-grid" style="grid-template-columns: ${gridCols};">
                    `;

                    // Create cells in the used column order
                    usedColumns.forEach(topNote => {
                        if (voicings[topNote]) {
                            // Convert array format to display string with top note emphasis
                            let voicingDisplay;
                            const voicing = voicings[topNote];
                            if (Array.isArray(voicing)) {
                                const notes = voicing.map((note, index) => {
                                    if (index === 0 && note.trim() !== '') {
                                        return `<span class="top-note">${note}</span>`;
                                    }
                                    return note;
                                });
                                voicingDisplay = notes.join('\n');
                            } else {
                                // For string format, emphasize first non-empty line
                                const lines = voicing.split('\n');
                                const firstNoteIndex = lines.findIndex(line => line.trim() !== '');
                                if (firstNoteIndex >= 0) {
                                    lines[firstNoteIndex] = `<span class="top-note">${lines[firstNoteIndex]}</span>`;
                                }
                                voicingDisplay = lines.join('\n');
                            }
                            html += `
                                <div class="voicing-cell" data-chord-type="${chordType}" data-scale="${scaleName}" data-top-note="${topNote}">
                                    <div class="chord-notes">${voicingDisplay}</div>
                                </div>
                            `;
                        } else {
                            // Empty cell for missing voicings
                            html += `
                                <div class="voicing-cell empty-cell">
                                    <div class="chord-notes">-</div>
                                </div>
                            `;
                        }
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            browseContent.innerHTML = html;
            
            // Initialize navigation for browse mode
            initializeChordTypeNavigation();
        }

        function initializeChordTypeNavigation() {
            const navItems = document.querySelectorAll('.chord-type-navigation .nav-item');
            const chordSections = document.querySelectorAll('.chord-type');
            
            // Add click handlers for smooth scrolling
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const chordType = item.getAttribute('data-chord-type');
                    const targetSection = document.getElementById(`${chordType}-chords`);
                    
                    if (targetSection) {
                        // Smooth scroll to section
                        targetSection.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start',
                            inline: 'nearest'
                        });
                        
                        // Update active state
                        updateActiveNavItem(item);
                    }
                });
            });
            
            // Add scroll listener to update active state based on scroll position
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(updateActiveNavOnScroll, 100);
            });
            
            // Initialize active state
            setTimeout(updateActiveNavOnScroll, 300);
        }

        function updateActiveNavItem(activeItem) {
            const navItems = document.querySelectorAll('.chord-type-navigation .nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            activeItem.classList.add('active');
        }

        function updateActiveNavOnScroll() {
            const navItems = document.querySelectorAll('.chord-type-navigation .nav-item');
            const chordSections = document.querySelectorAll('.chord-type');
            const scrollPosition = window.scrollY + window.innerHeight / 3;
            
            let activeSection = null;
            chordSections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.offsetHeight;
                
                if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
                    activeSection = section;
                }
            });
            
            if (activeSection) {
                const chordType = activeSection.id.replace('-chords', '');
                const activeNavItem = document.querySelector(`[data-chord-type="${chordType}"]`);
                if (activeNavItem) {
                    updateActiveNavItem(activeNavItem);
                }
            }
        }

        function toggleNavigation() {
            const nav = document.getElementById('chord-type-nav');
            const toggleBtn = nav.querySelector('.nav-toggle');
            
            if (nav.classList.contains('collapsed')) {
                nav.classList.remove('collapsed');
                toggleBtn.textContent = '−';
                toggleBtn.title = 'Collapse navigation';
            } else {
                nav.classList.add('collapsed');
                toggleBtn.textContent = '+';
                toggleBtn.title = 'Expand navigation';
            }
        }

        function loadProgressionMode() {
            const primaryDegrees = [
                { symbol: 'I', type: 'major', display: 'I (major)' },
                { symbol: 'i', type: 'minor', display: 'i (minor)' },
                { symbol: '♭II7', type: 'dominant', display: '♭II7 (dominant)' },
                { symbol: 'ii', type: 'minor', display: 'ii (minor)' },
                { symbol: 'iiø', type: 'half-diminished', display: 'iiø (half-diminished)' },
                { symbol: '♭III', type: 'major', display: '♭III (major)' },
                { symbol: 'iii', type: 'minor', display: 'iii (minor)' },
                { symbol: 'IV', type: 'major', display: 'IV (major)' },
                { symbol: 'iv', type: 'minor', display: 'iv (minor)' },
                { symbol: 'Vsus', type: 'sus', display: 'Vsus (sus)' },
                { symbol: 'V7', type: 'dominant', display: 'V7 (dominant)' },
                { symbol: '♭VI', type: 'major', display: '♭VI (major)' },
                { symbol: 'vi', type: 'minor', display: 'vi (minor)' },
                { symbol: '♭VII', type: 'dominant', display: '♭VII (dominant)' },
                { symbol: 'viiº7', type: 'diminished', display: 'viiº7 (diminished)' }
            ];

            const secondaryHarmony = [
                { symbol: 'Vsus/ii', type: 'sus', display: 'Vsus/ii (sus)' },
                { symbol: 'V7/ii', type: 'dominant', display: 'V7/ii (dominant)' },
                { symbol: 'iiø/', type: 'half-diminished', display: 'iiø/ (half-diminished)' },
                { symbol: 'Vsus/iii', type: 'sus', display: 'Vsus/iii (sus)' },
                { symbol: 'V7/iii', type: 'dominant', display: 'V7/iii (dominant)' },
                { symbol: 'Vsus/♭III', type: 'sus', display: 'Vsus/♭III (sus)' },
                { symbol: 'V7/♭III', type: 'dominant', display: 'V7/♭III (dominant)' },
                { symbol: 'Vsus/IV', type: 'sus', display: 'Vsus/IV (sus)' },
                { symbol: 'V7/IV', type: 'dominant', display: 'V7/IV (dominant)' },
                { symbol: 'Vsus/V', type: 'sus', display: 'Vsus/V (sus)' },
                { symbol: 'V7/V', type: 'dominant', display: 'V7/V (dominant)' },
                { symbol: 'Vsus/♭VI', type: 'sus', display: 'Vsus/♭VI (sus)' },
                { symbol: 'V7/♭VI', type: 'dominant', display: 'V7/♭VI (dominant)' },
                { symbol: 'Vsus/vi', type: 'sus', display: 'Vsus/vi (sus)' },
                { symbol: 'V7/vi', type: 'dominant', display: 'V7/vi (dominant)' },
                { symbol: 'V/', type: 'dominant', display: 'V/ (dominant)' },
                { symbol: '♭II7/', type: 'dominant', display: '♭II7/ (dominant)' },
                { symbol: 'viiº7/', type: 'diminished', display: 'viiº7/ (diminished)' },
                { symbol: 'rel. ii', type: 'minor', display: 'rel. ii (minor)' }
            ];

            // Load degree options
            const rootOptions = document.getElementById('root-options');
            let degreeHtml = '<h4 style="grid-column: 1/-1; color: #8B7D6B; margin: 0.5rem 0; text-align: center;">Primary Degrees</h4>';
            
            primaryDegrees.forEach(degree => {
                degreeHtml += `<div class="root-option" data-chord="${degree.symbol}" data-type="${degree.type}" draggable="true">${degree.symbol}</div>`;
            });

            degreeHtml += '<h4 style="grid-column: 1/-1; color: #8B7D6B; margin: 1rem 0 0.5rem 0; text-align: center;">Secondary Harmony</h4>';
            
            secondaryHarmony.forEach(degree => {
                degreeHtml += `<div class="root-option" data-chord="${degree.symbol}" data-type="${degree.type}" draggable="true">${degree.symbol}</div>`;
            });

            rootOptions.innerHTML = degreeHtml;

            // Add degree selection listeners - single click to add
            setupDegreeButtonListeners();
        }

        function setupDegreeButtonListeners() {
            const rootOptions = document.querySelectorAll('.root-option');
            
            rootOptions.forEach(option => {
                // Add click listener
                option.addEventListener('click', (e) => {
                    // Prevent adding chord if it was just dragged
                    if (isDragging) {
                        e.preventDefault();
                        return;
                    }
                    
                    const chord = option.dataset.chord;
                    if (chord) {
                        addChordToProgression(chord);
                    }
                });

                // Add drag listeners
                option.addEventListener('dragstart', (e) => {
                    isDragging = true;
                    draggedElement = option;
                    draggedNewChord = option.dataset.chord;
                    draggedChordId = null;
                    
                    e.dataTransfer.effectAllowed = 'copy';
                });

                option.addEventListener('dragend', (e) => {
                    // Delay clearing isDragging to prevent click events
                    setTimeout(() => {
                        isDragging = false;
                    }, 100);
                    
                    clearDropIndicators();
                    draggedElement = null;
                    draggedNewChord = null;
                });
            });
            
            // Initialize history for progression mode if not already initialized
            if (progressionHistory.length === 0) {
                progressionHistory = [JSON.parse(JSON.stringify(currentProgression))];
                historyIndex = 0;
                updateHistoryButtons();
            }
        }


        function addChordToProgression(chord) {
            console.log('➕ addChordToProgression: START', {
                chord,
                currentProgression: currentProgression.map(c => `${c.symbol}(${c.currentTopNote})`)
            });
            
            // Ensure history is initialized
            ensureHistoryInitialized();
            
            const chordType = getChordType(chord);
            let selectedVoicing = null;
            
            // If there's a previous chord, find the closest top note
            if (currentProgression.length > 0) {
                const lastChord = currentProgression[currentProgression.length - 1];
                selectedVoicing = getClosestVoicing(chordType, lastChord, chord);
            } else {
                // First chord - use default first voicing
                selectedVoicing = getFirstVoicing(chordType, chord);
            }
            
            const chordData = {
                id: Date.now(),
                symbol: chord,
                selectedVoicing: null,
                selectedVoicingKey: null,
                currentTopNote: selectedVoicing ? selectedVoicing.topNote : null,
                currentVoicingIndex: 0,
                scaleName: selectedVoicing ? selectedVoicing.scaleName : null,
                voicingWithPositions: null
            };
            
            // Use updateChordVoicing to properly set up the voicing data
            if (selectedVoicing) {
                updateChordVoicing(chordData, selectedVoicing);
            }
            
            currentProgression.push(chordData);
            
            console.log('➕ addChordToProgression: END', {
                newProgression: currentProgression.map(c => `${c.symbol}(${c.currentTopNote})`)
            });
            
            renderProgression();
            
            // Save state AFTER making changes
            saveToHistory();
        }

        function removeChordFromProgression(id) {
            currentProgression = currentProgression.filter(chord => chord.id !== id);
            renderProgression();
            
            // Save state AFTER making changes
            saveToHistory();
        }

        function renderProgression() {
            const container = document.getElementById('progression-container');
            
            if (currentProgression.length === 0) {
                container.innerHTML = '<div class="empty-progression">Click any Roman numeral degree to add it to your progression</div>';
                return;
            }

            let html = '';
            currentProgression.forEach((chord, index) => {
                const chordType = getChordType(chord.symbol);
                const allTopNotes = getAllTopNotes(chordType, chord.symbol);
                const currentTopNote = chord.currentTopNote;
                const voicingsForCurrentTopNote = getVoicingsForTopNote(chordType, currentTopNote, chord.symbol);
                
                // Find current top note index
                const topNoteIndex = allTopNotes.indexOf(currentTopNote);
                const canGoToPrevTopNote = topNoteIndex > 0;
                const canGoToNextTopNote = topNoteIndex < allTopNotes.length - 1;
                
                // Find current voicing index within the top note
                const canGoToPrevVoicing = chord.currentVoicingIndex > 0;
                const canGoToNextVoicing = chord.currentVoicingIndex < voicingsForCurrentTopNote.length - 1;
                
                html += `
                    <div class="chord-slot" data-chord-id="${chord.id}" draggable="true">
                        <div class="chord-header">
                            <span class="drag-handle">≡</span>
                            <span class="chord-symbol">${chord.symbol}</span>
                            <button class="remove-chord" onclick="removeChordFromProgression(${chord.id})">×</button>
                        </div>
                        <div class="voicing-selector">
                            <div class="voicing-navigation">
                                <div class="top-note-selector">
                                    <div class="top-note-label">Top Note</div>
                                    <select class="top-note-dropdown" onchange="changeTopNoteFromDropdown(${chord.id}, this.value)">
                                        ${allTopNotes.map(topNote => 
                                            `<option value="${topNote}" ${topNote === currentTopNote ? 'selected' : ''}>${topNote}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="voicing-navigation-controls">
                                    <button class="nav-arrow" onclick="changeVoicing(${chord.id}, -1)" ${!canGoToPrevVoicing ? 'disabled' : ''}>◀</button>
                                    <div class="voicing-counter">${chord.currentVoicingIndex + 1}/${voicingsForCurrentTopNote.length}</div>
                                    <button class="nav-arrow" onclick="changeVoicing(${chord.id}, 1)" ${!canGoToNextVoicing ? 'disabled' : ''}>▶</button>
                                </div>
                            </div>
                        </div>
                        <div class="selected-voicing" id="voicing-${chord.id}">
                            ${chord.voicingWithPositions ? 
                                `<div class="voicing-with-positions">
                                    ${chord.voicingWithPositions.map(voiceData => {
                                        if (voiceData === '') return '<div style="height: 0.5rem;"></div>';
                                        return `<div class="voice-position ${voiceData.isTopNote ? 'top-note' : ''}">
                                            <span class="voice-note">${voiceData.note}</span>
                                        </div>`;
                                    }).join('')}
                                </div>` 
                                : (chord.selectedVoicing || 'No voicing selected')
                            }
                            ${chord.selectedVoicing ? `<div class="voicing-scale-name">${chord.scaleName || ''}</div>` : ''}
                        </div>
                    </div>
                `;
                
                // Add voice leading connector if not the last chord
                if (index < currentProgression.length - 1) {
                    const nextChord = currentProgression[index + 1];
                    const movements = analyzeVoiceLeading(chord, nextChord);
                    
                    if (movements && movements.length > 0) {
                        const summary = getVoiceLeadingSummary(movements);
                        
                        // Create movement indicators that match the exact structure of chord.voicingWithPositions
                        const movementHtml = [];
                        
                        // Use the same structure as the first chord's voicingWithPositions
                        if (chord.voicingWithPositions) {
                            chord.voicingWithPositions.forEach((voiceData, index) => {
                                if (voiceData === '') {
                                    // Empty gap - add spacing
                                    movementHtml.push('<div style="height: 0.5rem;"></div>');
                                } else {
                                    // Find movement for this actual voice position
                                    const movement = movements.find(m => m.position === index);
                                    
                                    if (movement) {
                                        movementHtml.push(`<div class="voice-movement ${movement.type}" title="Voice ${movement.position + 1}: ${movement.from} → ${movement.to}">${movement.symbol}</div>`);
                                    } else {
                                        // Always show a movement indicator to maintain alignment
                                        movementHtml.push(`<div class="voice-movement" style="opacity: 0.3; background: rgba(255,255,255,0.1);">–</div>`);
                                    }
                                }
                            });
                        } else {
                            // Fallback: create indicators based on movements only
                            movements.forEach(movement => {
                                movementHtml.push(`<div class="voice-movement ${movement.type}" title="Voice ${movement.position + 1}: ${movement.from} → ${movement.to}">${movement.symbol}</div>`);
                            });
                        }
                        
                        // Generate movement summary like "s3", "l5", etc.
                        const movementSummary = generateMovementSummary({movements: movements});
                        
                        html += `
                            <div class="voice-leading-connector" title="${summary}">
                                ${movementHtml.join('')}
                                <div class="creator-movement-summary">
                                    ${movementSummary}
                                </div>
                            </div>
                        `;
                    }
                }
            });

            container.innerHTML = html;
            
            // Add drag event listeners to chord slots
            setupDragAndDrop();
        }

        // Drag and drop functionality
        let draggedElement = null;
        let draggedChordId = null;
        let draggedNewChord = null;
        let isDragging = false;

        function setupDragAndDrop() {
            const container = document.getElementById('progression-container');
            const chordSlots = container.querySelectorAll('.chord-slot');
            
            // Setup drag for existing chord slots
            chordSlots.forEach(slot => {
                setupChordSlotDrag(slot);
            });
            
            // Setup drop zones on container (only if not already set)
            if (!container.hasAttribute('data-drop-setup')) {
                setupDropZones(container);
                container.setAttribute('data-drop-setup', 'true');
            }
        }

        function setupChordSlotDrag(slot) {
            slot.addEventListener('dragstart', (e) => {
                isDragging = true;
                draggedElement = slot;
                draggedChordId = parseInt(slot.dataset.chordId);
                draggedNewChord = null;
                
                slot.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            slot.addEventListener('dragend', (e) => {
                setTimeout(() => {
                    isDragging = false;
                }, 100);
                
                slot.classList.remove('dragging');
                clearDropIndicators();
                draggedElement = null;
                draggedChordId = null;
            });

            slot.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (draggedElement && draggedElement !== slot) {
                    e.dataTransfer.dropEffect = 'move';
                    showDropIndicator(slot);
                }
            });

            slot.addEventListener('dragleave', (e) => {
                slot.classList.remove('drag-over');
            });

            slot.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedElement && draggedElement !== slot) {
                    handleChordDrop(slot);
                }
            });
        }


        function setupDropZones(container) {
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (draggedElement) {
                    e.dataTransfer.dropEffect = draggedNewChord ? 'copy' : 'move';
                }
            });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (draggedNewChord && isDragging) {
                    // Calculate drop position
                    const dropIndex = getDropIndex(e.clientX);
                    addChordAtPosition(draggedNewChord, dropIndex);
                }
            });
        }

        function handleChordDrop(targetSlot) {
            if (draggedChordId) {
                const targetChordId = parseInt(targetSlot.dataset.chordId);
                reorderChords(draggedChordId, targetChordId);
            }
        }

        function reorderChords(draggedId, targetId) {
            const draggedIndex = currentProgression.findIndex(c => c.id === draggedId);
            const targetIndex = currentProgression.findIndex(c => c.id === targetId);
            
            if (draggedIndex === -1 || targetIndex === -1) return;
            
            // Remove the dragged chord
            const [draggedChord] = currentProgression.splice(draggedIndex, 1);
            
            // Insert it at the target position
            currentProgression.splice(targetIndex, 0, draggedChord);
            
            // Re-analyze voice leading for the entire progression
            reanalyzeProgression();
            
            renderProgression();
        }

        function getDropIndex(clientX) {
            const container = document.getElementById('progression-container');
            const slots = container.querySelectorAll('.chord-slot');
            
            if (slots.length === 0) return 0;
            
            let dropIndex = slots.length;
            
            for (let i = 0; i < slots.length; i++) {
                const rect = slots[i].getBoundingClientRect();
                const slotMiddle = rect.left + rect.width / 2;
                
                if (clientX < slotMiddle) {
                    dropIndex = i;
                    break;
                }
            }
            
            return dropIndex;
        }

        function addChordAtPosition(chord, position) {
            const chordType = getChordType(chord);
            let selectedVoicing = null;
            
            // Find voice leading context for the new position
            let prevChord = null;
            let nextChord = null;
            
            if (position > 0) {
                prevChord = currentProgression[position - 1];
            }
            if (position < currentProgression.length) {
                nextChord = currentProgression[position];
            }
            
            // Choose voicing based on context
            if (prevChord) {
                selectedVoicing = getClosestVoicing(chordType, prevChord, chord);
            } else if (nextChord) {
                selectedVoicing = getClosestVoicing(chordType, nextChord, chord);
            } else {
                selectedVoicing = getFirstVoicing(chordType, chord);
            }
            
            const chordData = {
                id: Date.now(),
                symbol: chord,
                selectedVoicing: null,
                selectedVoicingKey: null,
                currentTopNote: selectedVoicing ? selectedVoicing.topNote : null,
                currentVoicingIndex: 0,
                scaleName: selectedVoicing ? selectedVoicing.scaleName : null,
                voicing: selectedVoicing ? selectedVoicing.voicing : null
            };
            
            if (selectedVoicing) {
                updateChordVoicing(chordData, selectedVoicing);
            }
            
            // Insert at specified position
            currentProgression.splice(position, 0, chordData);
            
            // Re-analyze voice leading for affected chords
            reanalyzeProgression();
            
            renderProgression();
        }

        function reanalyzeProgression() {
            // Re-analyze voice leading for all chord transitions
            for (let i = 1; i < currentProgression.length; i++) {
                const prevChord = currentProgression[i - 1];
                const currentChord = currentProgression[i];
                const chordType = getChordType(currentChord.symbol);
                
                // Find closest voicing based on previous chord
                const closestVoicing = getClosestVoicing(chordType, prevChord, currentChord.symbol);
                if (closestVoicing) {
                    updateChordVoicing(currentChord, closestVoicing);
                }
            }
        }

        function showDropIndicator(slot) {
            clearDropIndicators();
            slot.classList.add('drag-over');
        }

        function clearDropIndicators() {
            const slots = document.querySelectorAll('.chord-slot');
            slots.forEach(slot => {
                slot.classList.remove('drag-over');
            });
        }

        function getChordType(symbol) {
            if (symbol.includes('ø')) return 'half-diminished';
            if (symbol.includes('º')) return 'diminished';
            if (symbol.includes('sus')) return 'sus';
            if (symbol.includes('7') || symbol.includes('♭VII')) return 'dominant';
            if (symbol === 'i' || symbol === 'ii' || symbol === 'iii' || symbol === 'vi' || symbol === 'rel. ii') return 'minor';
            return 'major';
        }

        function getVoicingData(chordType) {
            return voicingData[chordType] || {};
        }

        function sortTopNotes(topNotes) {
            return topNotes.sort((a, b) => {
                // Remove ♭ and ♯ for sorting, just use the base number
                const getBaseNumber = (note) => {
                    const cleaned = note.replace(/[♭♯]/g, '');
                    return parseFloat(cleaned) || (cleaned === '♮7' ? 7 : 999);
                };
                return getBaseNumber(a) - getBaseNumber(b);
            });
        }

        function getFilteredVoicingData(chordType, chordSymbol) {
            const availableVoicings = voicingData[chordType] || {};
            
            // Filter out specific scales for degree ii
            if (chordSymbol === 'ii') {
                const filtered = { ...availableVoicings };
                if (filtered["Pentatonic ♭3"]) {
                    delete filtered["Pentatonic ♭3"];
                }
                if (filtered["Pentatonic ♭6 (from 5)"]) {
                    delete filtered["Pentatonic ♭6 (from 5)"];
                }
                return filtered;
            }
            
            return availableVoicings;
        }

        function getFirstVoicing(chordType, chordSymbol = null) {
            const availableVoicings = getFilteredVoicingData(chordType, chordSymbol);
            const scales = Object.keys(availableVoicings);
            if (scales.length === 0) return null;

            // Get all top notes and sort them
            const allTopNotes = getAllTopNotes(chordType, chordSymbol);
            if (allTopNotes.length === 0) return null;

            // Get first top note
            const firstTopNote = allTopNotes[0];
            
            // Get voicings for first top note
            const voicingsForFirstTopNote = getVoicingsForTopNote(chordType, firstTopNote, chordSymbol);
            if (voicingsForFirstTopNote.length === 0) return null;

            // Return first voicing of first top note
            return voicingsForFirstTopNote[0];
        }
        
        function getClosestVoicing(newChordType, previousChord, newChordSymbol = null) {
            // Get the previous chord's actual top note pitch
            const previousChordType = getChordType(previousChord.symbol);
            const previousTopNotePitch = getActualPitchInSemitones(previousChord.currentTopNote, previousChord.symbol, previousChordType);
            
            if (previousTopNotePitch === null) {
                // Fallback to first voicing if we can't calculate previous pitch
                return getFirstVoicing(newChordType);
            }
            
            // Get all available top notes for the new chord
            const allTopNotes = getAllTopNotes(newChordType, newChordSymbol);
            if (allTopNotes.length === 0) return null;
            
            let closestTopNote = null;
            let smallestInterval = Infinity;
            
            // Find the top note with the smallest interval to the previous top note
            allTopNotes.forEach(topNote => {
                // Use the actual new chord symbol for accurate pitch calculation
                const newTopNotePitch = getActualPitchInSemitones(topNote, newChordSymbol, newChordType);
                
                if (newTopNotePitch !== null) {
                    // Calculate interval (allowing for octave equivalence)
                    let interval = newTopNotePitch - previousTopNotePitch;
                    
                    // Normalize to within one octave for analysis
                    while (interval > 6) interval -= 12;
                    while (interval < -6) interval += 12;
                    
                    const absInterval = Math.abs(interval);
                    
                    if (absInterval < smallestInterval) {
                        smallestInterval = absInterval;
                        closestTopNote = topNote;
                    }
                }
            });
            
            if (!closestTopNote) {
                return getFirstVoicing(newChordType);
            }
            
            // Get voicings for the closest top note
            const voicingsForClosestTopNote = getVoicingsForTopNote(newChordType, closestTopNote, newChordSymbol);
            if (voicingsForClosestTopNote.length === 0) {
                return getFirstVoicing(newChordType, newChordSymbol);
            }
            
            // Return first voicing of the closest top note
            return voicingsForClosestTopNote[0];
        }

        function getVoicingsForTopNote(chordType, topNote, chordSymbol = null) {
            const availableVoicings = getFilteredVoicingData(chordType, chordSymbol);
            const voicings = [];
            
            Object.entries(availableVoicings).forEach(([scaleName, scaleVoicings]) => {
                if (scaleVoicings[topNote]) {
                    voicings.push({
                        key: `${scaleName}:${topNote}`,
                        topNote,
                        voicing: scaleVoicings[topNote],
                        scaleName
                    });
                }
            });

            return voicings;
        }

        function getAllTopNotes(chordType, chordSymbol = null) {
            const availableVoicings = getFilteredVoicingData(chordType, chordSymbol);
            const topNotes = new Set();
            
            Object.entries(availableVoicings).forEach(([scaleName, scaleVoicings]) => {
                Object.keys(scaleVoicings).forEach(topNote => topNotes.add(topNote));
            });

            return sortTopNotes([...topNotes]);
        }

        function getAvailableVoicings(chordType) {
            const voicingsByTopNote = {};
            
            // Group voicings by top note
            Object.entries(voicingData[chordType] || {}).forEach(([scaleName, scaleVoicings]) => {
                Object.entries(scaleVoicings).forEach(([topNote, voicing]) => {
                    if (!voicingsByTopNote[topNote]) {
                        voicingsByTopNote[topNote] = [];
                    }
                    
                    // Convert array format to display string - keep it horizontal for dropdown
                    let voicingDisplay;
                    if (Array.isArray(voicing)) {
                        voicingDisplay = voicing.join(' ');
                    } else {
                        voicingDisplay = voicing.replace(/\n/g, ' ');
                    }
                    
                    voicingsByTopNote[topNote].push({
                        key: `${scaleName}:${topNote}`,
                        label: voicingDisplay,
                        voicing: voicing,
                        scaleName: scaleName
                    });
                });
            });
            
            // Sort top notes and flatten the structure for dropdown
            const sortedTopNotes = Object.keys(voicingsByTopNote).sort((a, b) => {
                // Custom sort to handle numbers and symbols properly
                const aNum = parseFloat(a) || (a === '♭9' ? -0.5 : a === '♯9' ? 0.5 : a === '♯11' ? 4.5 : a === '♭13' ? 5.5 : 999);
                const bNum = parseFloat(b) || (b === '♭9' ? -0.5 : b === '♯9' ? 0.5 : b === '♯11' ? 4.5 : b === '♭13' ? 5.5 : 999);
                return aNum - bNum;
            });
            
            const result = [];
            sortedTopNotes.forEach(topNote => {
                // Add separator/header for each top note group
                result.push({
                    key: `header-${topNote}`,
                    label: `─── Top Note: ${topNote} ───`,
                    isHeader: true
                });
                
                // Add all voicings for this top note
                voicingsByTopNote[topNote].forEach(voicing => {
                    result.push(voicing);
                });
            });
            
            return result;
        }

        function changeTopNoteFromDropdown(chordId, newTopNote) {
            const chord = currentProgression.find(c => c.id === chordId);
            if (!chord) return;

            console.log('🎵 changeTopNoteFromDropdown: START', {
                chordSymbol: chord.symbol,
                oldTopNote: chord.currentTopNote,
                newTopNote,
                currentProgression: currentProgression.map(c => `${c.symbol}(${c.currentTopNote})`)
            });

            // Ensure history is initialized
            ensureHistoryInitialized();

            const chordType = getChordType(chord.symbol);
            const voicingsForNewTopNote = getVoicingsForTopNote(chordType, newTopNote, chord.symbol);
            
            if (voicingsForNewTopNote.length > 0) {
                // Set to first voicing of the new top note
                chord.currentTopNote = newTopNote;
                chord.currentVoicingIndex = 0;
                updateChordVoicing(chord, voicingsForNewTopNote[0]);
                
                console.log('🎵 changeTopNoteFromDropdown: END', {
                    chordSymbol: chord.symbol,
                    finalTopNote: chord.currentTopNote,
                    finalProgression: currentProgression.map(c => `${c.symbol}(${c.currentTopNote})`)
                });
                
                renderProgression();
                
                // Save state AFTER making changes
                saveToHistory();
            }
        }

        function changeVoicing(chordId, direction) {
            const chord = currentProgression.find(c => c.id === chordId);
            if (!chord) return;

            const chordType = getChordType(chord.symbol);
            const voicingsForCurrentTopNote = getVoicingsForTopNote(chordType, chord.currentTopNote, chord.symbol);
            const newIndex = chord.currentVoicingIndex + direction;

            if (newIndex >= 0 && newIndex < voicingsForCurrentTopNote.length) {
                // Ensure history is initialized
                ensureHistoryInitialized();
                
                chord.currentVoicingIndex = newIndex;
                updateChordVoicing(chord, voicingsForCurrentTopNote[newIndex]);
                renderProgression();
                
                // Save state AFTER making changes
                saveToHistory();
            }
        }

        function formatVoicingWithPositions(voicing, topNote) {
            if (!Array.isArray(voicing)) return voicing;
            
            const notes = [];
            voicing.forEach((note, index) => {
                notes.push(note);
                if ((index + 1) % 3 === 0 && index < voicing.length - 1) {
                    notes.push('');
                }
            });
            
            return notes.map((note, index) => {
                if (note === '') return '';
                const isTopNote = index === 0;
                const positionNum = index < 3 ? index + 1 : index;
                return {
                    note,
                    position: positionNum,
                    isTopNote
                };
            });
        }

        function updateChordVoicing(chord, voicingData) {
            // Store both simple and detailed voicing formats
            if (Array.isArray(voicingData.voicing)) {
                // Simple format for voice leading analysis
                const notes = [];
                voicingData.voicing.forEach((note, index) => {
                    notes.push(note);
                    if ((index + 1) % 3 === 0 && index < voicingData.voicing.length - 1) {
                        notes.push('');
                    }
                });
                chord.selectedVoicing = notes.join('\n');
                
                // Detailed format for enhanced display
                chord.voicingWithPositions = formatVoicingWithPositions(voicingData.voicing, voicingData.topNote);
            } else {
                chord.selectedVoicing = voicingData.voicing;
                chord.voicingWithPositions = null;
            }
            chord.selectedVoicingKey = voicingData.key;
            chord.scaleName = voicingData.scaleName;
        }


        // Save/Load Functions
        function saveProgression() {
            if (currentProgression.length === 0) {
                alert('No progression to save. Add some chords first!');
                return;
            }
            
            // Create simplified progression data for export
            const progressionData = {
                version: "1.0",
                created: new Date().toISOString(),
                progression: currentProgression.map(chord => ({
                    symbol: chord.symbol,
                    currentTopNote: chord.currentTopNote,
                    currentVoicingIndex: chord.currentVoicingIndex,
                    selectedVoicingKey: chord.selectedVoicingKey,
                    scaleName: chord.scaleName
                }))
            };
            
            // Create filename with timestamp
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
            const filename = `jazz-progression-${timestamp}.json`;
            
            // Download the file
            const blob = new Blob([JSON.stringify(progressionData, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function saveProgressionFromLibrary(progressionId, buttonElement) {
            const progressionData = JSON.parse(buttonElement.getAttribute('data-progression'));
            
            // Create the same format as the existing save function
            const exportData = {
                version: "1.0",
                created: new Date().toISOString(),
                progression: []
            };
            
            // Convert the progression library format (V7→I) to the standard save format
            // Add V7 chord
            if (progressionData.v7) {
                const v7Chord = progressionData.v7;
                exportData.progression.push({
                    symbol: "V7",
                    currentTopNote: v7Chord.topNote.toString(),
                    currentVoicingIndex: v7Chord.voicingIndex || 0,
                    selectedVoicingKey: `${v7Chord.scaleName}:${v7Chord.topNote}`,
                    scaleName: v7Chord.scaleName
                });
            }
            
            // Add I/i chord (determine type based on current progression type)
            if (progressionData.i) {
                const iChord = progressionData.i;
                const progressionType = document.getElementById('progression-type').value;
                const symbol = progressionType === 'V7-i' ? 'i' : 'I';
                
                exportData.progression.push({
                    symbol: symbol,
                    currentTopNote: iChord.topNote.toString(),
                    currentVoicingIndex: iChord.voicingIndex || 0,
                    selectedVoicingKey: `${iChord.scaleName}:${iChord.topNote}`,
                    scaleName: iChord.scaleName
                });
            }
            
            // Create filename
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
            const filename = `jazz-progression-${timestamp}.json`;
            
            // Download the file
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function loadProgression() {
            document.getElementById('file-input').click();
        }
        
        function clearProgression() {
            if (currentProgression.length === 0) {
                return; // Nothing to clear
            }
            
            currentProgression = [];
            renderProgression();
            
            // Save state AFTER making changes
            saveToHistory();
        }
        
        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate file format
                    if (!data.progression || !Array.isArray(data.progression)) {
                        throw new Error('Invalid progression file format');
                    }
                    
                    // Save state before loading new progression
                    saveToHistory();
                    
                    // Clear current progression
                    currentProgression = [];
                    
                    // Reconstruct progression
                    data.progression.forEach(chordData => {
                        const chordType = getChordType(chordData.symbol);
                        
                        // Find the specific voicing that was saved
                        const voicingsForTopNote = getVoicingsForTopNote(chordType, chordData.currentTopNote, chordData.symbol);
                        let selectedVoicing = null;
                        
                        // Try to find exact voicing by key or index
                        if (chordData.selectedVoicingKey) {
                            selectedVoicing = voicingsForTopNote.find(v => v.key === chordData.selectedVoicingKey);
                        }
                        if (!selectedVoicing && chordData.currentVoicingIndex < voicingsForTopNote.length) {
                            selectedVoicing = voicingsForTopNote[chordData.currentVoicingIndex];
                        }
                        if (!selectedVoicing && voicingsForTopNote.length > 0) {
                            selectedVoicing = voicingsForTopNote[0]; // Fallback
                        }
                        
                        if (selectedVoicing) {
                            const newChord = {
                                id: Date.now() + Math.random(), // Ensure unique ID
                                symbol: chordData.symbol,
                                selectedVoicing: null,
                                selectedVoicingKey: chordData.selectedVoicingKey,
                                currentTopNote: chordData.currentTopNote,
                                currentVoicingIndex: chordData.currentVoicingIndex,
                                scaleName: chordData.scaleName,
                                voicingWithPositions: null
                            };
                            
                            updateChordVoicing(newChord, selectedVoicing);
                            currentProgression.push(newChord);
                        }
                    });
                    
                    renderProgression();
                    
                } catch (error) {
                    alert('Error loading progression file: ' + error.message);
                }
                
                // Clear the file input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // Progression Library (Raw) Functions
        function loadProgressionsLibraryMode() {
            loadProgressionType();
        }

        function loadProgressionType() {
            const progressionType = document.getElementById('progression-type').value;
            const content = document.getElementById('progression-library-content');
            
            if (progressionType === 'V7-I') {
                content.innerHTML = generateV7IProgressions();
            } else if (progressionType === 'V7-i') {
                content.innerHTML = generateV7iProgressions();
            }
        }

        // Global variable to store all progressions data
        let allProgressionsData = {};

        function generateV7IProgressions() {
            // Get all V7 (dominant) and I (major) voicing combinations
            const v7Voicings = getAllVoicingCombinations('dominant');
            const iVoicings = getAllVoicingCombinations('major');
            
            
            // Group progressions by top-note-line with direction (relative to tonal center)
            const progressionsByTopNoteLine = {};
            
            v7Voicings.forEach(v7 => {
                iVoicings.forEach(i => {
                    // Calculate top-note-line relative to tonal center
                    const iTonalNote = getTonicRelativeNote(i.topNote, 'I');
                    const v7TonalNote = getTonicRelativeNote(v7.topNote, 'V7', i.topNote);
                    
                    // Skip if we can't map the notes
                    if (!v7TonalNote || !iTonalNote) return;
                    
                    // Skip harmonically invalid combinations
                    // ♯1 relative to tonic doesn't exist in proper V7-I progressions
                    if (v7TonalNote === '♯1' || iTonalNote === '♯1') {
                        return;
                    }
                    
                    // Calculate both upward and downward movements
                    const movements = calculateAllTopNoteMovements(v7TonalNote, iTonalNote);
                    
                    movements.forEach(movement => {
                        // Check if this voicing pair actually moves in the expected direction
                        const actualTopNoteMovement = calculateActualTopNoteMovement(v7.topNote, i.topNote);
                        const expectedUp = movement.direction === '↗';
                        const actualUp = actualTopNoteMovement > 0;
                        
                        
                        // Only add this voicing pair if it matches the expected direction
                        // Be more strict about direction matching
                        const isValidDirection = (expectedUp && actualUp) || 
                                               (!expectedUp && !actualUp);
                        
                        if (isValidDirection) {
                            const topNoteLine = `${v7TonalNote}-${iTonalNote}`;
                            
                            // Skip ♯1-2 progressions entirely - use ♭2-2 instead (same interval, different enharmonic spelling)
                            // ♭2-2 will be displayed as ♯1-2 in the UI for better readability
                            if (topNoteLine === '♯1-2') {
                                return;
                            }
                            
                            // Skip upward movements for ♭2-1 progressions (only show downward)
                            if (topNoteLine === '♭2-1' && movement.direction === '↗') {
                                return;
                            }
                            
                            // Skip downward movements for ♯2-3 progressions (only show upward)
                            if (topNoteLine === '♯2-3' && movement.direction === '↘') {
                                return;
                            }
                            
                            // Skip upward movements for ♭3-2 progressions (only show downward)
                            if (topNoteLine === '♭3-2' && movement.direction === '↗') {
                                return;
                            }
                            
                            // Skip downward movements for ♭2-2 progressions (only show upward)
                            if (topNoteLine === '♭2-2' && movement.direction === '↙') {
                                return;
                            }
                            
                            // Normalize enharmonic equivalents to consolidate navigation entries
                            // Convert ♭2-2 to ♯1-2 internally so they're treated as the same interval
                            let normalizedTopNoteLine = topNoteLine;
                            if (topNoteLine === '♭2-2') {
                                normalizedTopNoteLine = '♯1-2';
                            }
                            
                            const topNoteLineWithDirection = `${normalizedTopNoteLine} ${movement.direction}`;
                            
                            if (!progressionsByTopNoteLine[topNoteLineWithDirection]) {
                                progressionsByTopNoteLine[topNoteLineWithDirection] = [];
                            }
                            
                            progressionsByTopNoteLine[topNoteLineWithDirection].push({
                                v7: v7,
                                i: i,
                                movement: movement
                            });
                        }
                    });
                });
            });
            
            // Store data globally for filtering
            allProgressionsData = progressionsByTopNoteLine;
            
            
            // Generate navigation list
            generateTopNoteLineNavigation(progressionsByTopNoteLine);
            
            // Return empty string - user must filter first
            return '<div class="empty-state">Select a top-note-line from the left panel to view progressions.</div>';
        }

        function generateV7iProgressions() {
            // Get all V7 (dominant) and i (minor) voicing combinations
            const v7Voicings = getAllVoicingCombinations('dominant');
            const iVoicings = getAllVoicingCombinations('minor');
            
            
            // Group progressions by top-note-line with direction (relative to tonal center)
            const progressionsByTopNoteLine = {};
            
            v7Voicings.forEach(v7 => {
                iVoicings.forEach(i => {
                    // Calculate top-note-line relative to tonal center
                    const iTonalNote = getTonicRelativeNote(i.topNote, 'i');
                    const v7TonalNote = getTonicRelativeNote(v7.topNote, 'V7', i.topNote);
                    
                    // Debug logging for specific cases we're tracking
                    
                    // Skip if we can't map the notes
                    if (!v7TonalNote || !iTonalNote) {
                        return;
                    }
                    
                    // Skip harmonically invalid combinations
                    // ♯1 relative to tonic doesn't exist in proper V7-i progressions
                    if (v7TonalNote === '♯1' || iTonalNote === '♯1') {
                        return;
                    }
                    
                    // Calculate both upward and downward movements
                    const movements = calculateAllTopNoteMovements(v7TonalNote, iTonalNote);
                    
                    movements.forEach(movement => {
                        // Check if this voicing pair actually moves in the expected direction
                        const actualTopNoteMovement = calculateActualTopNoteMovement(v7.topNote, i.topNote);
                        const expectedUp = movement.direction === '↗';
                        const actualUp = actualTopNoteMovement > 0;
                        
                        
                        // Only add this voicing pair if it matches the expected direction
                        // Be more strict about direction matching
                        const isValidDirection = (expectedUp && actualUp) || 
                                               (!expectedUp && !actualUp);
                        
                        if (isValidDirection) {
                            const topNoteLine = `${v7TonalNote}-${iTonalNote}`;
                            
                            // Skip ♯1-2 progressions entirely - use ♭2-2 instead (same interval, different enharmonic spelling)
                            // ♭2-2 will be displayed as ♯1-2 in the UI for better readability
                            if (topNoteLine === '♯1-2') {
                                return;
                            }
                            
                            // Skip upward movements for ♭2-1 progressions (only show downward)
                            if (topNoteLine === '♭2-1' && movement.direction === '↗') {
                                return;
                            }
                            
                            // Skip downward movements for ♯2-3 progressions (only show upward)
                            if (topNoteLine === '♯2-3' && movement.direction === '↘') {
                                return;
                            }
                            
                            // Skip upward movements for ♭3-2 progressions (only show downward)
                            if (topNoteLine === '♭3-2' && movement.direction === '↗') {
                                return;
                            }
                            
                            // Skip downward movements for ♭2-2 progressions (only show upward)
                            if (topNoteLine === '♭2-2' && movement.direction === '↙') {
                                return;
                            }
                            
                            // Normalize enharmonic equivalents to consolidate navigation entries
                            // Convert ♭2-2 to ♯1-2 internally so they're treated as the same interval
                            let normalizedTopNoteLine = topNoteLine;
                            if (topNoteLine === '♭2-2') {
                                normalizedTopNoteLine = '♯1-2';
                            }
                            
                            const topNoteLineWithDirection = `${normalizedTopNoteLine} ${movement.direction}`;
                            
                            if (!progressionsByTopNoteLine[topNoteLineWithDirection]) {
                                progressionsByTopNoteLine[topNoteLineWithDirection] = [];
                            }
                            
                            progressionsByTopNoteLine[topNoteLineWithDirection].push({
                                v7: v7,
                                i: i,
                                movement: movement
                            });
                        }
                    });
                });
            });
            
            // Store data globally for filtering
            allProgressionsData = progressionsByTopNoteLine;
            
            // Get all generated top-note-lines
            const allTopNoteLines = Object.keys(progressionsByTopNoteLine);
            
            // Generate navigation list
            generateTopNoteLineNavigation(progressionsByTopNoteLine);
            
            // Return empty string - user must filter first
            return '<div class="empty-state">Select a top-note-line from the left panel to view progressions.</div>';
        }

        function getTopNoteLineDisplayLabel(topNoteLineWithDirection) {
            const [movement, direction] = topNoteLineWithDirection.split(' ');
            let [start, end] = movement.split('-');
            
            // Apply enharmonic corrections for better voice leading logic
            if (start === '♭6' && end === '6') {
                start = '♯5'; // ♭6-6 becomes ♯5-6
            } else if (start === '♯6' && end === '6') {
                start = '♭7'; // ♯6-6 becomes ♭7-6
            } else if (start === '♭2' && end === '2') {
                start = '♯1'; // ♭2-2 becomes ♯1-2 for display
            }
            
            // Check if it's a common tone
            if (start === end && direction === '→') {
                return `${start}-${end}`;
            }
            
            // For 1 semitone movements, use ♯/♭ notation
            const semitoneMap = {
                '1': 0, '♭2': 1, '2': 2, '♯2': 3, '♭3': 3, '3': 4,
                '4': 5, '♯4': 6, '♭5': 6, '5': 7, '♯5': 8, '♭6': 8,
                '6': 9, '♯6': 10, '♭7': 10, '7': 11, '♯7': 11, '♯1': 12
            };
            
            const startSemitone = semitoneMap[start] ?? 0;
            const endSemitone = semitoneMap[end] ?? 0;
            const semitoneDistance = Math.abs(endSemitone - startSemitone);
            
            // Temporarily disabled 1-semitone conversion to debug
            // if (semitoneDistance === 1) {
            //     // For 1 semitone movements, use ♯/♭ notation
            //     if (direction === '↗') {
            //         // Going up: use ♯ on start note
            //         const sharpStart = start === '1' ? '♯1' : start === '2' ? '♯2' : start === '4' ? '♯4' : start === '5' ? '♯5' : start === '6' ? '♯6' : start;
            //         return `${sharpStart}-${end} ${direction}`;
            //     } else if (direction === '↘') {
            //         // Going down: use ♭ on end note  
            //         const flatEnd = end === '2' ? '♭2' : end === '3' ? '♭3' : end === '5' ? '♭5' : end === '6' ? '♭6' : end === '7' ? '♭7' : end;
            //         return `${start}-${flatEnd} ${direction}`;
            //     }
            // }
            
            // For non-common tones, show the movement pattern with "-"
            return `${start}-${end} ${direction}`;
        }

        function getSortMethod() {
            const checkedRadio = document.querySelector('input[name="sort-method"]:checked');
            return checkedRadio ? checkedRadio.value : 'closeness';
        }

        function refreshNavigation() {
            if (allProgressionsData && Object.keys(allProgressionsData).length > 0) {
                generateTopNoteLineNavigation(allProgressionsData);
            }
        }

        function generateTopNoteLineNavigation(progressionsByTopNoteLine) {
            const navList = document.getElementById('top-note-line-list');
            const sortMethod = getSortMethod();
            
            // Sort top-note-lines based on selected method
            const sortedTopNoteLines = Object.keys(progressionsByTopNoteLine).sort((a, b) => {
                if (sortMethod === 'count') {
                    // Sort by number of progressions (descending)
                    const aCount = progressionsByTopNoteLine[a].length;
                    const bCount = progressionsByTopNoteLine[b].length;
                    return bCount - aCount;
                } else {
                    // Sort by interval closeness using consistent comparison function
                    const [aMovement, aDirection] = a.split(' ');
                    const [bMovement, bDirection] = b.split(' ');
                    
                    // Use the same comparison logic as Library pages
                    return compareTopNoteLines(aMovement, bMovement);
                }
            });
            
            let navHTML = '';
            sortedTopNoteLines.forEach(topNoteLineWithDirection => {
                const progressions = progressionsByTopNoteLine[topNoteLineWithDirection];
                const count = progressions.length;
                
                // Extract the movement info for display
                const sampleProgression = progressions[0];
                const movement = sampleProgression.movement;
                
                // Create a cleaner display label
                const displayLabel = getTopNoteLineDisplayLabel(topNoteLineWithDirection);
                
                navHTML += `
                    <div class="top-note-line-item" onclick="filterByTopNoteLine('${topNoteLineWithDirection}')">
                        <span class="top-note-line-name">${displayLabel}</span>
                        <span class="top-note-line-count">${count}</span>
                    </div>
                `;
            });
            
            navList.innerHTML = navHTML;
        }

        function generateProgressionsHTML(progressionsByTopNoteLine, selectedTopNoteLine = null) {
            // Sort top-note-lines by interval closeness, then alphabetically (same as navigation)
            const sortedTopNoteLines = Object.keys(progressionsByTopNoteLine).sort((a, b) => {
                // Parse top-note-line with direction (e.g., "7-1 ↘" or "2-3 ↗")
                const [aMovement, aDirection] = a.split(' ');
                const [bMovement, bDirection] = b.split(' ');
                const [aStart, aEnd] = aMovement.split('-');
                const [bStart, bEnd] = bMovement.split('-');
                
                // Calculate interval size using semitones for accurate measurement
                const semitoneMap = {
                    '1': 0, '♭2': 1, '2': 2, '♯2': 3, '♭3': 3, '3': 4, '♮3': 4,
                    '4': 5, '♯4': 6, '♭5': 6, '5': 7, '♯5': 8, '♭6': 8,
                    '6': 9, '♮6': 9, '♯6': 10, '♭7': 10, '7': 11, '♮7': 11, '♯1': 12
                };
                
                const aStartSemitone = semitoneMap[aStart] ?? 0;
                const aEndSemitone = semitoneMap[aEnd] ?? 0;
                const bStartSemitone = semitoneMap[bStart] ?? 0;
                const bEndSemitone = semitoneMap[bEnd] ?? 0;
                
                // Calculate interval distance - common tones get priority score
                let aInterval, bInterval;
                
                // Check if these are true common tones (same note to same note AND → direction)
                const isACommonTone = aStart === aEnd && aDirection === '→';
                const isBCommonTone = bStart === bEnd && bDirection === '→';
                
                // Assign interval values - common tones get -1 to sort first
                if (isACommonTone) {
                    aInterval = -1;
                } else {
                    // For upward direction (↗), use the upward distance
                    if (aDirection === '↗') {
                        const directInterval = aEndSemitone - aStartSemitone;
                        aInterval = directInterval >= 0 ? directInterval : directInterval + 12;
                    } 
                    // For downward direction (↘), use the downward distance
                    else if (aDirection === '↘') {
                        const directInterval = aEndSemitone - aStartSemitone;
                        aInterval = directInterval <= 0 ? Math.abs(directInterval) : 12 - directInterval;
                    }
                    // For common tone (→), interval is 0
                    else {
                        aInterval = 0;
                    }
                }
                
                // Same calculation for b
                if (isBCommonTone) {
                    bInterval = -1;
                } else {
                    if (bDirection === '↗') {
                        const directInterval = bEndSemitone - bStartSemitone;
                        bInterval = directInterval >= 0 ? directInterval : directInterval + 12;
                    } 
                    else if (bDirection === '↘') {
                        const directInterval = bEndSemitone - bStartSemitone;
                        bInterval = directInterval <= 0 ? Math.abs(directInterval) : 12 - directInterval;
                    }
                    else {
                        bInterval = 0;
                    }
                }
                
                // First sort by interval size (smaller intervals first)
                if (aInterval !== bInterval) {
                    return aInterval - bInterval;
                }
                
                // Then sort alphabetically by the movement part (without direction and accidentals)
                if (aMovement !== bMovement) {
                    // Remove accidentals for comparison (♭, ♯, ♮)
                    const normalizeForSort = (movement) => {
                        return movement.replace(/[♭♯♮]/g, '');
                    };
                    const aNormalized = normalizeForSort(aMovement);
                    const bNormalized = normalizeForSort(bMovement);
                    
                    if (aNormalized !== bNormalized) {
                        return aNormalized.localeCompare(bNormalized);
                    }
                    
                    // If base movement is same, sort by actual movement (with accidentals)
                    return aMovement.localeCompare(bMovement);
                }
                
                // Finally sort by direction (↗ before ↘ before →)
                const directionOrder = { '↗': 1, '→': 2, '↘': 3 };
                return (directionOrder[aDirection] || 4) - (directionOrder[bDirection] || 4);
            });
            
            let html = '';
            const linesToShow = selectedTopNoteLine ? [selectedTopNoteLine] : sortedTopNoteLines;
            
            linesToShow.forEach(topNoteLineWithDirection => {
                const progressions = progressionsByTopNoteLine[topNoteLineWithDirection];
                if (progressions) {
                    html += generateTopNoteLineSection(topNoteLineWithDirection, progressions);
                }
            });
            
            return html;
        }

        function filterByTopNoteLine(topNoteLine) {
            // Update navigation active state
            document.querySelectorAll('.top-note-line-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Set active item
            event.target.closest('.top-note-line-item').classList.add('active');
            
            // Update title with clean display label
            const displayLabel = getTopNoteLineDisplayLabel(topNoteLine);
            document.getElementById('current-filter-title').textContent = `Top-Note-Line: ${displayLabel}`;
            
            // Filter and display progressions
            const filteredData = { [topNoteLine]: allProgressionsData[topNoteLine] };
            const html = generateProgressionsHTML(filteredData, topNoteLine);
            document.getElementById('progression-library-content').innerHTML = html;
            
            // Add touch event handlers for mobile highlighting
            addTouchHighlighting();
        }

        function normalizeSearchTerm(term) {
            // Normalize common symbol variations for flexible search
            return term
                .replace(/b/g, '♭')      // b -> ♭
                .replace(/#/g, '♯')      // # -> ♯
                .replace(/n/g, '♮');     // n -> ♮
        }

        function filterTopNoteLines() {
            const searchInput = document.getElementById('search-input');
            const rawSearchTerm = searchInput.value.toLowerCase().trim();
            const searchTerm = normalizeSearchTerm(rawSearchTerm);
            const navItems = document.querySelectorAll('.top-note-line-item');
            
            navItems.forEach(item => {
                const displayText = item.textContent.toLowerCase();
                
                let shouldShow = false;
                
                if (rawSearchTerm === '') {
                    shouldShow = true;
                } else {
                    // Check if display text contains the search term
                    shouldShow = displayText.includes(searchTerm);
                }
                
                item.style.display = shouldShow ? 'block' : 'none';
            });
        }


        function getAllVoicingCombinations(chordType) {
            const combinations = [];
            const chordTypeData = voicingData[chordType] || {};
            
            Object.entries(chordTypeData).forEach(([scaleName, scaleVoicings]) => {
                Object.entries(scaleVoicings).forEach(([topNote, voicing]) => {
                    combinations.push({
                        scaleName,
                        topNote,
                        voicing,
                        chordType
                    });
                });
            });
            
            return combinations;
        }

        function getTonicRelativeNote(topNote, chordFunction, resolvesToNote = null) {
            // Convert chord-relative top note to tonic-relative scale degree
            // Determine if we're in minor context - check both possible progression type elements
            let progressionType = document.getElementById('progression-type')?.value || 
                                document.getElementById('progression-type-files')?.value || 
                                'V7-I';
            const isMinorContext = progressionType === 'V7-i';
            
            const chordTonicMapping = {
                'V7': isMinorContext ? {
                    '1': '5', '3': '♮7', '5': '2', '7': '4', 
                    '♭9': '♭6', '9': '♮6', '♯9': '♭7', 
                    '♯11': '♭2', '♭13': '♭3', '13': '♮3'
                } : {
                    '1': '5', '3': '7', '5': '2', '7': '4', 
                    '♭9': '♭6', '9': '6', '♯9': '♯6', 
                    '♯11': '♭2', '♭13': '♭3', '13': '3'
                },
                'I': {
                    '1': '1', '♭2': '♭2', '2': '2', '♯2': '♯2', '3': '3', '5': '5', '7': '7',
                    '9': '2', '♯11': '♯4', '13': '6'
                },
                'i': {
                    '1': '1', '♭2': '♭2', '2': '2', '♭3': '♭3', '3': '♭3', '4': '4', '5': '5', 
                    '♭6': '♭6', '6': '♮6', '♭7': '♭7', '7': '♭7', '♮7': '♮7',
                    '9': '2', '11': '4', '♯11': '♯4', '13': '♮6', '♭13': '♭6'
                }
            };
            
            let result = chordTonicMapping[chordFunction][topNote];
            
            // Special case: V7 ♭13 maps to ♯2 only when resolving to I 3, otherwise ♭3
            if (chordFunction === 'V7' && topNote === '♭13' && resolvesToNote) {
                const targetChordFunction = isMinorContext ? 'i' : 'I';
                const iTonicNote = chordTonicMapping[targetChordFunction][resolvesToNote];
                result = (iTonicNote === '3') ? '♯2' : '♭3';
            }
            
            return result || null;
        }

        function getScaleNumber(note) {
            const noteValues = {
                '1': 1, '♭2': 1.5, '2': 2, '♯2': 2.5, '♭3': 3, '3': 3.5,
                '4': 4, '♯4': 4.5, '♭5': 4.5, '5': 5, '♯5': 5.5, '♭6': 6,
                '6': 6.5, '♯6': 6.5, '♭7': 7, '7': 7.5, '♯7': 7.5
            };
            return noteValues[note] || 8;
        }

        function calculateActualTopNoteMovement(v7TopNote, iTopNote) {
            // Calculate the actual semitone movement between tonal mappings, not raw chord tones
            const progressionType = document.getElementById('progression-type')?.value || 'V7-I';
            const isMinor = progressionType === 'V7-i';
            
            // Get the tonal mappings for both notes
            const v7TonalNote = getTonicRelativeNote(v7TopNote, 'V7', iTopNote);
            const iTonalNote = getTonicRelativeNote(iTopNote, isMinor ? 'i' : 'I');
            
            if (!v7TonalNote || !iTonalNote) return 0;
            
            // Now compare the tonal mappings using semitones
            const semitoneMap = {
                '1': 0, '♭2': 1, '2': 2, '♯2': 3, '♭3': 3, '3': 4, '♮3': 4,
                '4': 5, '♯4': 6, '♭5': 6, '5': 7, '♯5': 8, '♭6': 8,
                '6': 9, '♮6': 9, '♯6': 10, '♭7': 10, '7': 11, '♮7': 11
            };
            
            const v7TonalSemitone = semitoneMap[v7TonalNote] ?? 0;
            const iTonalSemitone = semitoneMap[iTonalNote] ?? 0;
            
            // Calculate direct interval between tonal mappings
            let interval = iTonalSemitone - v7TonalSemitone;
            
            // Normalize to within one octave for analysis
            while (interval > 6) interval -= 12;
            while (interval < -6) interval += 12;
            
            return interval;
        }

        function calculateAllTopNoteMovements(fromNote, toNote) {
            // Convert scale degrees to semitones (C major scale reference)
            const semitoneMap = {
                '1': 0, '♭2': 1, '2': 2, '♯2': 3, '♭3': 3, '3': 4, '♮3': 4,
                '4': 5, '♯4': 6, '♭5': 6, '5': 7, '♯5': 8, '♭6': 8,
                '6': 9, '♮6': 9, '♯6': 10, '♭7': 10, '7': 11, '♮7': 11
            };
            
            const fromSemitone = semitoneMap[fromNote];
            const toSemitone = semitoneMap[toNote];
            
            if (fromSemitone === undefined || toSemitone === undefined) {
                return [{ interval: 0, direction: '→', type: 'common tone', description: 'Unknown movement', semitones: 0 }];
            }
            
            // Calculate direct interval
            const directInterval = toSemitone - fromSemitone;
            
            // Handle common tone
            if (directInterval === 0) {
                return [{
                    interval: 0,
                    direction: '→',
                    type: 'common tone',
                    description: 'Common tone',
                    semitones: 0
                }];
            }
            
            // Calculate both upward and downward possibilities
            const upwardInterval = directInterval >= 0 ? directInterval : directInterval + 12;
            const downwardInterval = directInterval <= 0 ? directInterval : directInterval - 12;
            
            const movements = [];
            
            // Add upward movement
            if (upwardInterval > 0 && upwardInterval <= 12) {
                const type = upwardInterval <= 2 ? 'step' : 'leap';
                movements.push({
                    interval: upwardInterval,
                    direction: '↗',
                    type: type,
                    description: `${upwardInterval} semitone${upwardInterval > 1 ? 's' : ''} up`,
                    semitones: upwardInterval
                });
            }
            
            // Add downward movement
            if (downwardInterval < 0 && Math.abs(downwardInterval) <= 12) {
                const semitones = Math.abs(downwardInterval);
                const type = semitones <= 2 ? 'step' : 'leap';
                movements.push({
                    interval: downwardInterval,
                    direction: '↘',
                    type: type,
                    description: `${semitones} semitone${semitones > 1 ? 's' : ''} down`,
                    semitones: semitones
                });
            }
            
            return movements;
        }

        function generateTopNoteLineSection(topNoteLineWithDirection, progressions) {
            // Extract movement info from the first progression
            const sampleProgression = progressions[0];
            const movement = sampleProgression.movement;
            
            // Use the same clean display label as in navigation
            const displayLabel = getTopNoteLineDisplayLabel(topNoteLineWithDirection);
            
            let html = `
                <div class="top-note-line-group">
                    <div class="top-note-line-header">
                        <div class="top-note-line-title">${displayLabel}</div>
                    </div>
                    <div class="progression-variations">
            `;
            
            // Sort progressions first by accidentals count, then by semitone total (both ascending)
            const sortedProgressions = progressions.sort((a, b) => {
                // First priority: fewer accidentals
                const aAccidentals = countAccidentals(a);
                const bAccidentals = countAccidentals(b);
                
                if (aAccidentals !== bAccidentals) {
                    return aAccidentals - bAccidentals;
                }
                
                // Second priority: fewer semitones (use actual voice movement calculation)
                const aSemitones = calculateActualVoiceMovement(a);
                const bSemitones = calculateActualVoiceMovement(b);
                
                if (aSemitones !== bSemitones) {
                    return aSemitones - bSemitones;
                }
                
                // Third priority: alphabetical by scale name for stable sorting
                const aScaleName = `${a.v7.scaleName}-${a.i.scaleName}`;
                const bScaleName = `${b.v7.scaleName}-${b.i.scaleName}`;
                return aScaleName.localeCompare(bScaleName);
            });
            
            sortedProgressions.forEach((progression, index) => {
                // Determine chord type based on current progression type
                const progressionType = document.getElementById('progression-type').value;
                const chordType = progressionType === 'V7-i' ? 'minor' : 'major';
                html += generateProgressionVariation(progression, chordType, index + 1, sortedProgressions.length);
            });
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        function getMovementDescription(startNote, endNote) {
            const startNum = getScaleNumber(startNote);
            const endNum = getScaleNumber(endNote);
            const interval = endNum - startNum;
            
            if (interval === 0) return 'Common tone';
            if (Math.abs(interval) <= 1) return 'Step motion';
            if (interval > 0) return `Up ${Math.abs(interval)} scale degrees`;
            return `Down ${Math.abs(interval)} scale degrees`;
        }

        function formatVoicingForDisplay(voicing) {
            if (!Array.isArray(voicing)) return voicing;
            
            // Display notes vertically - each note on its own line
            // This represents the actual piano hand position from top to bottom
            return voicing.map(note => note || '').join('\n');
        }

        function generateVoiceLeadingLines(analysis) {
            if (!analysis || !analysis.movements) return '';
            
            return analysis.movements.map((movement, index) => {
                const colorClass = movement.type === 'common' ? 'common-tone' : 
                                  movement.type === 'step' ? 'step-motion' : 'leap-motion';
                return `<div class="voice-line ${colorClass}" style="top: ${index * 20 + 10}px;"></div>`;
            }).join('');
        }

        function generateMovementSummary(analysis) {
            if (!analysis || !analysis.movements) return '';
            
            const commonTones = analysis.movements.filter(m => m.type === 'common').length;
            const steps = analysis.movements.filter(m => m.type === 'step').length;
            const leaps = analysis.movements.filter(m => m.type === 'leap').length;
            
            // Calculate total semitones
            const totalSemitones = analysis.movements.reduce((sum, m) => {
                return sum + (m.semitones || m.absInterval || 0);
            }, 0);
            
            return `
                <div class="movement-counts">
                    ${totalSemitones > 0 ? `<span class="count total-semitones">${totalSemitones}S</span>` : ''}
                    ${leaps > 0 ? `<span class="count leap-motion">${leaps}L</span>` : ''}
                </div>
            `;
        }

        function analyzeVoiceLeadingDirect(voicing1, voicing2, expectedMovement = null) {
            const movements = [];
            
            // Analyze each voice position including gaps
            for (let i = 0; i < Math.max(voicing1.length, voicing2.length); i++) {
                const note1 = voicing1[i];
                const note2 = voicing2[i];
                
                // Only analyze if both notes exist and are not empty
                if (note1 && note2 && note1.trim() !== '' && note2.trim() !== '') {
                    const movement = calculateVoiceMovementWithDirection(note1, note2, expectedMovement);
                    movements.push({
                        position: i,
                        from: note1,
                        to: note2,
                        ...movement
                    });
                }
            }
            
            return movements;
        }

        function calculateVoiceMovementWithDirection(note1, note2, expectedMovement) {
            console.log(`DEBUG WithDirection: ${note1} → ${note2}`);
            
            // Determine chord type based on current progression type
            const progressionType = document.getElementById('progression-type')?.value || 'V7-I';
            const isMinor = progressionType === 'V7-i';
            const targetChordSymbol = isMinor ? 'i' : 'I';
            const targetChordType = isMinor ? 'minor' : 'major';
            
            // Get basic movement first
            const baseMovement = calculateVoiceMovement(note1, note2, 'V7', 'dominant', targetChordSymbol, targetChordType);
            
            // If no expected movement provided, or it's a common tone, return as-is
            if (!expectedMovement || note1 === note2 || baseMovement.interval === 0) {
                return baseMovement;
            }
            
            // Special cases for classic voice-leading resolutions - match main function
            // Leading tone resolution (V7 7th → I 3rd)
            if (note1 === '7' && note2 === '3') {
                return {
                    interval: -1,
                    direction: 'down',
                    type: 'step',
                    symbol: '↓½',
                    semitones: 1,
                    absInterval: 1
                };
            }
            
            // ♭13 resolution (V7 ♭13 → I 9)
            if (note1 === '♭13' && note2 === '9') {
                return {
                    interval: -1,
                    direction: 'down',
                    type: 'step',
                    symbol: '↓½',
                    semitones: 1,
                    absInterval: 1
                };
            }
            
            // V7-I special resolutions (match main calculateVoiceMovement function)
            console.log(`DEBUG: Checking special cases for ${note1} → ${note2}`);
            
            // ♯9 (V7) resolves up by semitone to natural 7 (I)
            if (note1 === '♯9' && note2 === '7') {
                console.log('DEBUG: Matched ♯9 → 7 in WithDirection function');
                return {
                    interval: 1,
                    direction: 'up',
                    type: 'step',
                    symbol: '↑½',
                    semitones: 1,
                    absInterval: 1
                };
            }
            
            // 3 (V7) as leading tone resolves up by semitone to 1 (I)
            if (note1 === '3' && note2 === '1') {
                return {
                    interval: 1,
                    direction: 'up',
                    type: 'step',
                    symbol: '↑½',
                    semitones: 1,
                    absInterval: 1
                };
            }
            
            // ♯9 (V7) resolves up by semitone to 13 (I)
            if (note1 === '♯9' && note2 === '13') {
                return {
                    interval: 1,
                    direction: 'up',
                    type: 'step',
                    symbol: '↑½',
                    semitones: 1,
                    absInterval: 1
                };
            }
            
            // ♭9 (V7) resolves up by semitone to 13 (I)
            if (note1 === '♭9' && note2 === '13') {
                return {
                    interval: 1,
                    direction: 'up',
                    type: 'step',
                    symbol: '↑½',
                    semitones: 1,
                    absInterval: 1
                };
            }
            
            // ♭9 (V7) resolves up by semitone to 7 (I)
            if (note1 === '♭9' && note2 === '7') {
                return {
                    interval: 1,
                    direction: 'up',
                    type: 'step',
                    symbol: '↑½',
                    semitones: 1,
                    absInterval: 1
                };
            }
            
            // 9 (V7) resolves up by whole tone to 1 (I)
            if (note1 === '9' && note2 === '1') {
                console.log('DEBUG: Matched 9 → 1 special case in WithDirection function');
                return {
                    interval: 2,
                    direction: 'up',
                    type: 'step',
                    symbol: '↑1',
                    semitones: 2,
                    absInterval: 2
                };
            }
            
            // 9 (V7) resolves down to 5 (I) - actually a compound movement that should show as ↑1
            if (note1 === '9' && note2 === '5') {
                console.log('DEBUG: Matched 9 → 5 special case in WithDirection function');
                return {
                    interval: 2,
                    direction: 'up',
                    type: 'step',
                    symbol: '↑1',
                    semitones: 2,
                    absInterval: 2
                };
            }
            
            // 9 (V7) resolves down to 7 (I) - should show as ↑1 not ↓½
            if (note1 === '9' && note2 === '7') {
                console.log('DEBUG: Matched 9 → 7 special case in WithDirection function');
                return {
                    interval: 2,
                    direction: 'up',
                    type: 'step',
                    symbol: '↑1',
                    semitones: 2,
                    absInterval: 2
                };
            }
            
            // Apply directional context for interval display
            const expectedUp = expectedMovement.direction === '↗';
            const expectedDown = expectedMovement.direction === '↘';
            const actualInterval = baseMovement.interval;
            const actualUp = actualInterval > 0;
            const actualDown = actualInterval < 0;
            
            
            // If the actual movement direction contradicts the expected direction,
            // apply octave correction for better harmonic representation
            if (((expectedUp && actualDown) || (expectedDown && actualUp))) {
                
                // Apply octave displacement correction
                // If expected upward but actual downward: add 12 to make it upward
                // If expected downward but actual upward: subtract 12 to make it downward
                const correctedInterval = expectedUp ? 
                    (actualInterval + 12) : (actualInterval - 12);
                
                const correctedAbs = Math.abs(correctedInterval);
                const correctedDirection = correctedInterval === 0 ? 'same' : correctedInterval > 0 ? 'up' : 'down';
                
                
                let correctedType, correctedSymbol;
                if (correctedInterval === 0) {
                    correctedType = 'common';
                    correctedSymbol = '=';
                } else if (correctedAbs <= 2) {
                    correctedType = 'step';
                    if (correctedAbs === 1) {
                        correctedSymbol = correctedDirection === 'up' ? '↑½' : '↓½';
                    } else {
                        correctedSymbol = correctedDirection === 'up' ? '↑1' : '↓1';
                    }
                } else {
                    correctedType = 'leap';
                    const semitoneCount = correctedAbs % 2 === 0 ? correctedAbs / 2 : `${Math.floor(correctedAbs / 2)}½`;
                    correctedSymbol = correctedDirection === 'up' ? `↑${semitoneCount}` : `↓${semitoneCount}`;
                }
                
                return {
                    interval: correctedInterval,
                    direction: correctedDirection,
                    type: correctedType,
                    symbol: correctedSymbol,
                    semitones: correctedAbs,
                    absInterval: correctedAbs
                };
            }
            
            // Otherwise return the original calculation
            return baseMovement;
        }

        function generateLibraryVoiceLeadingConnector(fromChord, toChord, expectedMovement) {
            // Analyze voice leading directly with the voicing arrays, considering expected direction
            const movements = analyzeVoiceLeadingDirect(fromChord.voicing, toChord.voicing, expectedMovement);
            
            if (!movements || movements.length === 0) {
                return '<div class="empty-connector">No voice leading data</div>';
            }
            
            const summary = getVoiceLeadingSummary(movements);
            const movementHtml = [];
            
            // Create movement indicators based on the first chord's voicing structure
            if (fromChord.voicing) {
                fromChord.voicing.forEach((note, index) => {
                    if (!note || note.trim() === '') {
                        // Empty gap - add spacing, no movement indicator needed
                        movementHtml.push('<div style="height: 0.5rem;"></div>');
                    } else {
                        // Check if the corresponding position in the second chord is also a gap
                        const toNote = toChord.voicing[index];
                        if (!toNote || toNote.trim() === '') {
                            // Voice disappears - still add spacing
                            movementHtml.push('<div style="height: 0.5rem;"></div>');
                        } else {
                            // Find movement for this voice position
                            const movement = movements.find(m => m.position === index);
                            
                            if (movement) {
                                movementHtml.push(`<div class="voice-movement ${movement.type}" title="Voice ${movement.position + 1}: ${movement.from} → ${movement.to}">${movement.symbol}</div>`);
                            } else {
                                // If we have notes in both positions but no movement found, something's wrong
                                // Show a faded indicator but this shouldn't happen
                                movementHtml.push(`<div class="voice-movement" style="opacity: 0.3; background: rgba(255,255,255,0.1);">?</div>`);
                            }
                        }
                    }
                });
            } else {
                // Fallback: create indicators based on movements only
                movements.forEach(movement => {
                    movementHtml.push(`<div class="voice-movement ${movement.type}" title="Voice ${movement.position + 1}: ${movement.from} → ${movement.to}">${movement.symbol}</div>`);
                });
            }
            
            return `
                <div class="connector-indicators" title="${summary}">
                    ${movementHtml.join('')}
                </div>
                <div class="movement-summary">
                    ${generateMovementSummary({movements: movements})}
                </div>
            `;
        }

        function formatVoicingForAnalysis(voicing) {
            if (!Array.isArray(voicing)) return voicing;
            
            // Convert array to newline-separated string format that analyzeVoiceLeading expects
            const notes = [];
            voicing.forEach((note, index) => {
                notes.push(note);
                // Add gaps after every 3 notes (similar to updateChordVoicing)
                if ((index + 1) % 3 === 0 && index < voicing.length - 1) {
                    notes.push('');
                }
            });
            return notes.join('\n');
        }

        function generateProgressionVariation(progression, chordType = 'major', progressionNumber = null, totalProgressions = null) {
            // Format voicings for display
            const v7VoicingFormatted = formatVoicingForDisplay(progression.v7.voicing);
            const iVoicingFormatted = formatVoicingForDisplay(progression.i.voicing);
            
            // Get voice leading analysis - use the direct function since we have voicing arrays
            const voiceLeadingAnalysis = analyzeVoiceLeadingDirect(progression.v7.voicing, progression.i.voicing);
            
            // Create unique ID for this progression variation
            const progressionId = `v7-${progression.v7.scaleName.replace(/[^a-zA-Z0-9]/g, '')}-${progression.v7.topNote}-i-${progression.i.scaleName.replace(/[^a-zA-Z0-9]/g, '')}-${progression.i.topNote}`;
            
            // Check if this progression is in the library
            const libraryInfo = isProgressionInLibrary(
                progression.v7.topNote, 
                progression.v7.scaleName, 
                progression.i.topNote, 
                progression.i.scaleName
            );
            
            return `
                <div class="progression-variation">
                    ${libraryInfo.inLibrary ? `<div class="library-indicator" title="${libraryInfo.fileName}">Library</div>` : ''}
                    ${progressionNumber && totalProgressions ? `<div class="progression-number">${progressionNumber}/${totalProgressions}</div>` : ''}
                    <div class="library-progression-display">
                        <div class="library-chord">
                            <div class="chord-header">
                                <span class="chord-symbol">V7</span>
                            </div>
                            <div class="voicing-display">
                                <div class="voicing-content">${v7VoicingFormatted}</div>
                                <div class="scale-indicator">${progression.v7.scaleName}</div>
                            </div>
                        </div>
                        
                        <div class="voice-leading-connector library">
                            ${generateLibraryVoiceLeadingConnector(progression.v7, progression.i, progression.movement)}
                        </div>
                        
                        <div class="library-chord">
                            <div class="chord-header">
                                <span class="chord-symbol">${chordType === 'major' ? 'I' : 'i'}</span>
                            </div>
                            <div class="voicing-display">
                                <div class="voicing-content">${iVoicingFormatted}</div>
                                <div class="scale-indicator">${progression.i.scaleName}</div>
                            </div>
                        </div>
                    </div>
                    <div class="progression-actions">
                        <button class="save-progression-btn" onclick="saveProgressionFromLibrary('${progressionId}', this)" data-progression='${JSON.stringify(progression)}'>
                            Save Progression
                        </button>
                    </div>
                </div>
            `;
        }

        // Progression Library Functions (JSON Files)
        // Embedded progression data (no external file dependencies)
        const embeddedProgressions = {
            "2-2 Bluesy": {"version":"1.0","created":"2025-08-10T07:33:20.104Z","progression":[{"symbol":"V7","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2 (♯9):5","scaleName":"Pentatonic \"dominant\" ♯2 (♯9)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:9","scaleName":"Pentatonic"}]},
            "2-2 everything falls to place": {"version":"1.0","created":"2025-08-10T07:36:39.132Z","progression":[{"symbol":"V7","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (from ♭3):5","scaleName":"Pentatonic \"dominant\" ♭2 (from ♭3)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:9","scaleName":"Pentatonic"}]},
            "2-2 opening": {"version":"1.0","created":"2025-08-10T07:32:10.072Z","progression":[{"symbol":"V7","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (♭9):5","scaleName":"Pentatonic \"dominant\" ♭2 (♭9)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):9","scaleName":"Pentatonic (from 2)"}]},
            "2-2 simply solid": {"version":"1.0","created":"2025-08-10T07:30:02.113Z","progression":[{"symbol":"V7","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (♭9):5","scaleName":"Pentatonic \"dominant\" ♭2 (♭9)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:9","scaleName":"Pentatonic"}]},
            "2-2 spicy to bright": {"version":"1.0","created":"2025-08-10T07:24:04.148Z","progression":[{"symbol":"V7","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (from 6):5","scaleName":"Pentatonic \"dominant\" ♭2 (from 6)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):9","scaleName":"Pentatonic (from 2)"}]},
            "2-2 static relief ": {"version":"1.0","created":"2025-08-10T07:35:04.655Z","progression":[{"symbol":"V7","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (from ♭3):5","scaleName":"Pentatonic \"dominant\" ♭2 (from ♭3)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):9","scaleName":"Pentatonic (from 5)"}]},
            "2-2 black and white": {"version":"1.0","created":"2025-08-11T12:07:45.285Z","progression":[{"symbol":"V7","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2 (♯9):5","scaleName":"Pentatonic \"dominant\" ♯2 (♯9)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":9","scaleName":"Pentatonic \"major 7\""}]},
            "2-2 clean and soft": {"version":"1.0","created":"2025-08-11T12:08:38.024Z","progression":[{"symbol":"V7","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\":5","scaleName":"Pentatonic \"dominant\""},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":9","scaleName":"Pentatonic \"major 7\""}]},
            "2-2 spicy to soft": {"version":"1.0","created":"2025-08-11T12:09:14.846Z","progression":[{"symbol":"V7","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (from ♭3):5","scaleName":"Pentatonic \"dominant\" ♭2 (from ♭3)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":9","scaleName":"Pentatonic \"major 7\""}]},
            "3-3 classic decisive ": {"version":"1.0","created":"2025-08-10T12:32:18.116Z","progression":[{"symbol":"V7","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"phrygian steps\" (from 6):13","scaleName":"Pentatonic \"phrygian steps\" (from 6)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:3","scaleName":"Pentatonic"}]},
            "3-3 classic": {"version":"1.0","created":"2025-08-10T12:30:55.931Z","progression":[{"symbol":"V7","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"phrygian steps\" (from 6):13","scaleName":"Pentatonic \"phrygian steps\" (from 6)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):3","scaleName":"Pentatonic (from 5)"}]},
            "3-3 rich": {"version":"1.0","created":"2025-08-10T07:46:10.231Z","progression":[{"symbol":"V7","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (from 6):13","scaleName":"Pentatonic \"dominant\" ♭2 (from 6)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:3","scaleName":"Pentatonic"}]},
            "3-3 simplifying complexity ": {"version":"1.0","created":"2025-08-10T07:47:59.209Z","progression":[{"symbol":"V7","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (from ♭5):13","scaleName":"Pentatonic \"dominant\" ♭2 (from ♭5)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):3","scaleName":"Pentatonic (from 5)"}]},
            "3-3 soft landing": {"version":"1.0","created":"2025-08-10T07:43:57.241Z","progression":[{"symbol":"V7","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (from 6):13","scaleName":"Pentatonic \"dominant\" ♭2 (from 6)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):3","scaleName":"Pentatonic (from 5)"}]},
            "3-3 spicy classic with a twist": {"version":"1.0","created":"2025-08-10T12:31:28.804Z","progression":[{"symbol":"V7","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"phrygian steps\" ♭4 (from 6):13","scaleName":"Pentatonic \"phrygian steps\" ♭4 (from 6)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):3","scaleName":"Pentatonic (from 2)"}]},
            "3-3 spicy classic": {"version":"1.0","created":"2025-08-10T12:33:15.163Z","progression":[{"symbol":"V7","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"phrygian steps\" ♭4 (from 6):13","scaleName":"Pentatonic \"phrygian steps\" ♭4 (from 6)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):3","scaleName":"Pentatonic (from 5)"}]},
            "3-3 upper dreams": {"version":"1.0","created":"2025-08-10T07:53:01.027Z","progression":[{"symbol":"V7","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"diminished steps\":13","scaleName":"Pentatonic \"diminished steps\""},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):3","scaleName":"Pentatonic (from 2)"}]},
            "3-3 wonder": {"version":"1.0","created":"2025-08-10T07:42:19.828Z","progression":[{"symbol":"V7","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (from 6):13","scaleName":"Pentatonic \"dominant\" ♭2 (from 6)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):3","scaleName":"Pentatonic (from 2)"}]},
            "5-5 augmented above": {"version":"1.0","created":"2025-08-10T09:21:35.998Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"WT (from ♭6):1","scaleName":"WT (from ♭6)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):5","scaleName":"Pentatonic (from 5)"}]},
            "5-5 augmented below": {"version":"1.0","created":"2025-08-10T09:22:06.101Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 7):1","scaleName":"WT (from 7)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):5","scaleName":"Pentatonic (from 5)"}]},
            "5-5 augmented multi-downward": {"version":"1.0","created":"2025-08-10T09:38:01.903Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 3):1","scaleName":"WT (from 3)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:5","scaleName":"Pentatonic"}]},
            "5-5 classic": {"version":"1.0","created":"2025-08-10T12:36:45.351Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"phrygian steps\" (from 6):1","scaleName":"Pentatonic \"phrygian steps\" (from 6)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):5","scaleName":"Pentatonic (from 5)"}]},
            "5-5 clean 1-way motion": {"version":"1.0","created":"2025-08-10T09:47:00.378Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant 1-3-5-6-7\":1","scaleName":"Pentatonic \"dominant 1-3-5-6-7\""},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:5","scaleName":"Pentatonic"}]},
            "5-5 clean cool narrow": {"version":"1.0","created":"2025-08-10T09:49:43.509Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant 1-3-5-6-7\":1","scaleName":"Pentatonic \"dominant 1-3-5-6-7\""},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):5","scaleName":"Pentatonic (from 5)"}]},
            "5-5 cool narrow": {"version":"1.0","created":"2025-08-10T09:47:54.668Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" (from ♭5) ♯2, ♭5:1","scaleName":"Pentatonic \"dominant\" (from ♭5) ♯2, ♭5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):5","scaleName":"Pentatonic (from 5)"}]},
            "5-5 decisive augmented from above": {"version":"1.0","created":"2025-08-10T09:31:43.834Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"WT (from ♭6):1","scaleName":"WT (from ♭6)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:5","scaleName":"Pentatonic"}]},
            "5-5 decisive augmented from below": {"version":"1.0","created":"2025-08-10T09:32:20.880Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 7):1","scaleName":"WT (from 7)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:5","scaleName":"Pentatonic"}]},
            "5-5 decisive classic": {"version":"1.0","created":"2025-08-10T12:35:14.325Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"phrygian steps\" (from 6):1","scaleName":"Pentatonic \"phrygian steps\" (from 6)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:5","scaleName":"Pentatonic"}]},
            "5-5 decisive inner minor": {"version":"1.0","created":"2025-08-10T09:34:55.794Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♭5:1","scaleName":"Pentatonic \"dominant\" ♯2, ♭5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:5","scaleName":"Pentatonic"}]},
            "5-5 decisive inner tritone": {"version":"1.0","created":"2025-08-10T09:32:54.281Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♭5:1","scaleName":"Pentatonic \"dominant\" ♭2, ♭5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:5","scaleName":"Pentatonic"}]},
            "5-5 decisive pinch": {"version":"1.0","created":"2025-08-10T09:23:15.187Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (♭9):1","scaleName":"Pentatonic \"dominant\" ♭2 (♭9)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:5","scaleName":"Pentatonic"}]},
            "5-5 decisive rich": {"version":"1.0","created":"2025-08-10T09:36:22.208Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♯5:1","scaleName":"Pentatonic \"dominant\" ♯2, ♯5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:5","scaleName":"Pentatonic"}]},
            "5-5 decisive worries throw away": {"version":"1.0","created":"2025-08-10T09:33:25.886Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♯5:1","scaleName":"Pentatonic \"dominant\" ♭2, ♯5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:5","scaleName":"Pentatonic"}]},
            "5-5 inner minor resolution": {"version":"1.0","created":"2025-08-10T09:29:42.222Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♭5:1","scaleName":"Pentatonic \"dominant\" ♯2, ♭5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):5","scaleName":"Pentatonic (from 5)"}]},
            "5-5 inner tritone resolution": {"version":"1.0","created":"2025-08-10T09:25:38.748Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♭5:1","scaleName":"Pentatonic \"dominant\" ♭2, ♭5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):5","scaleName":"Pentatonic (from 5)"}]},
            "5-5 narrow": {"version":"1.0","created":"2025-08-10T09:46:04.206Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" (from ♭5) ♯2, ♭5:1","scaleName":"Pentatonic \"dominant\" (from ♭5) ♯2, ♭5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:5","scaleName":"Pentatonic"}]},
            "5-5 rich and cool": {"version":"1.0","created":"2025-08-10T09:30:34.482Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♯5:1","scaleName":"Pentatonic \"dominant\" ♯2, ♯5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):5","scaleName":"Pentatonic (from 5)"}]},
            "5-5 simply clean": {"version":"1.0","created":"2025-08-10T09:15:55.685Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\":1","scaleName":"Pentatonic \"dominant\""},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:5","scaleName":"Pentatonic"}]},
            "5-5 simply cool": {"version":"1.0","created":"2025-08-10T09:19:05.064Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2 (♯9):1","scaleName":"Pentatonic \"dominant\" ♯2 (♯9)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):5","scaleName":"Pentatonic (from 5)"}]},
            "5-5 small pinch": {"version":"1.0","created":"2025-08-10T09:18:19.935Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (♭9):1","scaleName":"Pentatonic \"dominant\" ♭2 (♭9)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):5","scaleName":"Pentatonic (from 5)"}]},
            "5-5 spicy classic": {"version":"1.0","created":"2025-08-10T12:38:18.618Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"phrygian steps\" ♭4 (from 6):1","scaleName":"Pentatonic \"phrygian steps\" ♭4 (from 6)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):5","scaleName":"Pentatonic (from 5)"}]},
            "5-5 spicy decisive classic": {"version":"1.0","created":"2025-08-10T12:39:09.664Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"phrygian steps\" ♭4 (from 6):1","scaleName":"Pentatonic \"phrygian steps\" ♭4 (from 6)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:5","scaleName":"Pentatonic"}]},
            "5-5 worries throw away": {"version":"1.0","created":"2025-08-10T09:27:55.063Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♯5:1","scaleName":"Pentatonic \"dominant\" ♭2, ♯5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):5","scaleName":"Pentatonic (from 5)"}]},
            "5-5 augmented landing": {"version":"1.0","created":"2025-08-11T11:41:25.795Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 3):1","scaleName":"WT (from 3)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":5","scaleName":"Pentatonic \"major 7\""}]},
            "5-5 classic soft": {"version":"1.0","created":"2025-08-11T11:43:12.396Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\":1","scaleName":"Pentatonic \"dominant\""},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":5","scaleName":"Pentatonic \"major 7\""}]},
            "5-5 spicy to soft": {"version":"1.0","created":"2025-08-11T11:44:28.593Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♭5:1","scaleName":"Pentatonic \"dominant\" ♯2, ♭5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":5","scaleName":"Pentatonic \"major 7\""}]},
            "5-5 rich implode": {"version":"1.0","created":"2025-08-11T11:45:43.639Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♯5:1","scaleName":"Pentatonic \"dominant\" ♯2, ♯5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":5","scaleName":"Pentatonic \"major 7\""}]},
            "5-5 narrow soft": {"version":"1.0","created":"2025-08-11T11:47:09.888Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" (from ♭5) ♯2, ♭5:1","scaleName":"Pentatonic \"dominant\" (from ♭5) ♯2, ♭5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":5","scaleName":"Pentatonic \"major 7\""}]},
            "5-5 clean and soft": {"version":"1.0","created":"2025-08-11T11:48:07.156Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant 1-3-5-6-7\":1","scaleName":"Pentatonic \"dominant 1-3-5-6-7\""},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":5","scaleName":"Pentatonic \"major 7\""}]},
            "5-5 augmented implode": {"version":"1.0","created":"2025-08-11T11:50:16.313Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"WT (from ♭6):1","scaleName":"WT (from ♭6)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":5","scaleName":"Pentatonic \"major 7\""}]},
            "5-5 inner augmented soft": {"version":"1.0","created":"2025-08-11T11:51:28.987Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 7):1","scaleName":"WT (from 7)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":5","scaleName":"Pentatonic \"major 7\""}]},
            "5-5 clean double implode": {"version":"1.0","created":"2025-08-11T11:52:33.201Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"phrygian steps\" (from 6):1","scaleName":"Pentatonic \"phrygian steps\" (from 6)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":5","scaleName":"Pentatonic \"major 7\""}]},
            "5-5 inner tritone soft": {"version":"1.0","created":"2025-08-11T11:53:24.651Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♭5:1","scaleName":"Pentatonic \"dominant\" ♭2, ♭5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":5","scaleName":"Pentatonic \"major 7\""}]},
            "5-5 worries soft": {"version":"1.0","created":"2025-08-11T11:54:16.567Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♯5:1","scaleName":"Pentatonic \"dominant\" ♭2, ♯5"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":5","scaleName":"Pentatonic \"major 7\""}]},
            "5-5 diminished soft": {"version":"1.0","created":"2025-08-11T11:55:05.838Z","progression":[{"symbol":"V7","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"phrygian steps\" ♭4 (from 6):1","scaleName":"Pentatonic \"phrygian steps\" ♭4 (from 6)"},{"symbol":"I","currentTopNote":"5","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":5","scaleName":"Pentatonic \"major 7\""}]},
            "6-6 augmented from above": {"version":"1.0","created":"2025-08-10T09:53:23.351Z","progression":[{"symbol":"V7","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"WT (from ♭6):9","scaleName":"WT (from ♭6)"},{"symbol":"I","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):13","scaleName":"Pentatonic (from 5)"}]},
            "6-6 augmented from below": {"version":"1.0","created":"2025-08-10T09:54:22.665Z","progression":[{"symbol":"V7","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 7):9","scaleName":"WT (from 7)"},{"symbol":"I","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):13","scaleName":"Pentatonic (from 5)"}]},
            "6-6 augmented neat": {"version":"1.0","created":"2025-08-10T09:56:10.382Z","progression":[{"symbol":"V7","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"WT (from ♭6):9","scaleName":"WT (from ♭6)"},{"symbol":"I","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:13","scaleName":"Pentatonic"}]},
            "6-6 neat": {"version":"1.0","created":"2025-08-10T09:51:54.059Z","progression":[{"symbol":"V7","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\":9","scaleName":"Pentatonic \"dominant\""},{"symbol":"I","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:13","scaleName":"Pentatonic"}]},
            "6-6 whole tone neat": {"version":"1.0","created":"2025-08-10T09:57:05.174Z","progression":[{"symbol":"V7","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 7):9","scaleName":"WT (from 7)"},{"symbol":"I","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:13","scaleName":"Pentatonic"}]},
            "6-6 augmented landing": {"version":"1.0","created":"2025-08-11T12:11:18.557Z","progression":[{"symbol":"V7","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 7):9","scaleName":"WT (from 7)"},{"symbol":"I","currentTopNote":"13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"minor 7\" (from 6):13","scaleName":"Pentatonic \"minor 7\" (from 6)"}]},
            "7-7 augmented above bright": {"version":"1.0","created":"2025-08-10T12:58:40.704Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"WT (from ♭6):3","scaleName":"WT (from ♭6)"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):7","scaleName":"Pentatonic (from 2)"}]},
            "7-7 augmented from above": {"version":"1.0","created":"2025-08-10T12:47:50.549Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"WT (from ♭6):3","scaleName":"WT (from ♭6)"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):7","scaleName":"Pentatonic (from 5)"}]},
            "7-7 augmented from below": {"version":"1.0","created":"2025-08-10T12:49:47.578Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 7):3","scaleName":"WT (from 7)"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):7","scaleName":"Pentatonic (from 5)"}]},
            "7-7 classic bright": {"version":"1.0","created":"2025-08-10T12:59:55.545Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"phrygian steps\" (from 6):3","scaleName":"Pentatonic \"phrygian steps\" (from 6)"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):7","scaleName":"Pentatonic (from 2)"}]},
            "7-7 classic": {"version":"1.0","created":"2025-08-10T12:50:33.542Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"phrygian steps\" (from 6):3","scaleName":"Pentatonic \"phrygian steps\" (from 6)"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):7","scaleName":"Pentatonic (from 5)"}]},
            "7-7 diminished leap": {"version":"1.0","created":"2025-08-10T13:15:32.524Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"diminished steps\":3","scaleName":"Pentatonic \"diminished steps\""},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):7","scaleName":"Pentatonic (from 5)"}]},
            "7-7 easy step": {"version":"1.0","created":"2025-08-10T09:58:45.964Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\":3","scaleName":"Pentatonic \"dominant\""},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):7","scaleName":"Pentatonic (from 5)"}]},
            "7-7 exploding lower tritone": {"version":"1.0","created":"2025-08-10T12:53:16.164Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♭5:3","scaleName":"Pentatonic \"dominant\" ♭2, ♭5"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):7","scaleName":"Pentatonic (from 5)"}]},
            "7-7 inner tritone bright": {"version":"1.0","created":"2025-08-10T13:08:32.038Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" (from ♭5):3","scaleName":"Pentatonic \"dominant\" (from ♭5)"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):7","scaleName":"Pentatonic (from 2)"}]},
            "7-7 inner tritone resolution ": {"version":"1.0","created":"2025-08-10T13:12:44.348Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" (from ♭5):3","scaleName":"Pentatonic \"dominant\" (from ♭5)"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):7","scaleName":"Pentatonic (from 5)"}]},
            "7-7 spicy bright": {"version":"1.0","created":"2025-08-10T12:52:08.809Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (♭9):3","scaleName":"Pentatonic \"dominant\" ♭2 (♭9)"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):7","scaleName":"Pentatonic (from 2)"}]},
            "7-7 spicy classic bright": {"version":"1.0","created":"2025-08-10T13:09:10.826Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"phrygian steps\" ♭4 (from 6):3","scaleName":"Pentatonic \"phrygian steps\" ♭4 (from 6)"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):7","scaleName":"Pentatonic (from 2)"}]},
            "7-7 spicy classic": {"version":"1.0","created":"2025-08-10T13:00:36.018Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"phrygian steps\" ♭4 (from 6):3","scaleName":"Pentatonic \"phrygian steps\" ♭4 (from 6)"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):7","scaleName":"Pentatonic (from 5)"}]},
            "7-7 spicy static": {"version":"1.0","created":"2025-08-10T12:43:31.138Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (♭9):3","scaleName":"Pentatonic \"dominant\" ♭2 (♭9)"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):7","scaleName":"Pentatonic (from 5)"}]},
            "7-7 tritone exploding to bright": {"version":"1.0","created":"2025-08-10T13:06:05.811Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♭5:3","scaleName":"Pentatonic \"dominant\" ♭2, ♭5"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):7","scaleName":"Pentatonic (from 2)"}]},
            "7-7 whole tone bright": {"version":"1.0","created":"2025-08-10T12:57:30.043Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 2):3","scaleName":"WT (from 2)"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):7","scaleName":"Pentatonic (from 2)"}]},
            "7-7 whole tone upwards bright": {"version":"1.0","created":"2025-08-10T13:10:14.726Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 3):3","scaleName":"WT (from 3)"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):7","scaleName":"Pentatonic (from 2)"}]},
            "7-7 whole tone upwards": {"version":"1.0","created":"2025-08-10T13:13:44.412Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 3):3","scaleName":"WT (from 3)"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):7","scaleName":"Pentatonic (from 5)"}]},
            "7-7 worries throw away": {"version":"1.0","created":"2025-08-10T12:56:13.651Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♯5:3","scaleName":"Pentatonic \"dominant\" ♭2, ♯5"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):7","scaleName":"Pentatonic (from 5)"}]},
            "7-7 worries to bright": {"version":"1.0","created":"2025-08-10T13:06:58.399Z","progression":[{"symbol":"V7","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♯5:3","scaleName":"Pentatonic \"dominant\" ♭2, ♯5"},{"symbol":"I","currentTopNote":"7","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):7","scaleName":"Pentatonic (from 2)"}]},
            "♭2-1 downwards ": {"version":"1.0","created":"2025-08-11T08:12:47.190Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" (from ♭5):♯11","scaleName":"Pentatonic \"dominant\" (from ♭5)"},{"symbol":"I","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:1","scaleName":"Pentatonic"}]},
            "♭2-1 spicy downwards": {"version":"1.0","created":"2025-08-11T08:14:23.424Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (from ♭5):♯11","scaleName":"Pentatonic \"dominant\" ♭2 (from ♭5)"},{"symbol":"I","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:1","scaleName":"Pentatonic"}]},
            "♭2-1 upper major": {"version":"1.0","created":"2025-08-11T08:17:07.325Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic ♭6 (from 2):♯11","scaleName":"Pentatonic ♭6 (from 2)"},{"symbol":"I","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:1","scaleName":"Pentatonic"}]},
            "♭2-1 upper minor": {"version":"1.0","created":"2025-08-11T08:18:38.133Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♭5:♯11","scaleName":"Pentatonic \"dominant\" ♯2, ♭5"},{"symbol":"I","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:1","scaleName":"Pentatonic"}]},
            "♭2-1 upper tritone": {"version":"1.0","created":"2025-08-11T08:17:30.645Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♭5:♯11","scaleName":"Pentatonic \"dominant\" ♭2, ♭5"},{"symbol":"I","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:1","scaleName":"Pentatonic"}]},
            "♭2-1 whole tone decisive": {"version":"1.0","created":"2025-08-11T08:11:39.169Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 3):♯11","scaleName":"WT (from 3)"},{"symbol":"I","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:1","scaleName":"Pentatonic"}]},
            "♭2-1 whole tone downwards ": {"version":"1.0","created":"2025-08-11T08:13:45.784Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 2):♯11","scaleName":"WT (from 2)"},{"symbol":"I","currentTopNote":"1","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:1","scaleName":"Pentatonic"}]},
            "♯1-2 upper major bright": {"version":"1.0","created":"2025-08-11T08:35:38.863Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic ♭6 (from 2):♯11","scaleName":"Pentatonic ♭6 (from 2)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):9","scaleName":"Pentatonic (from 2)"}]},
            "♯1-2 augmented explode": {"version":"1.0","created":"2025-08-11T08:54:17.493Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 7):♯11","scaleName":"WT (from 7)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):9","scaleName":"Pentatonic (from 5)"}]},
            "♯1-2 upper tritone explode": {"version":"1.0","created":"2025-08-11T08:55:05.005Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♭5:♯11","scaleName":"Pentatonic \"dominant\" ♭2, ♭5"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):9","scaleName":"Pentatonic (from 5)"}]},
            "♯1-2 upper minor explode": {"version":"1.0","created":"2025-08-11T08:55:38.476Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♭5:♯11","scaleName":"Pentatonic \"dominant\" ♯2, ♭5"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):9","scaleName":"Pentatonic (from 5)"}]},
            "♯1-2 whole tone upwards bright": {"version":"1.0","created":"2025-08-11T08:57:20.177Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 2):♯11","scaleName":"WT (from 2)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):9","scaleName":"Pentatonic (from 2)"}]},
            "♯1-2 augmented explode decisive": {"version":"1.0","created":"2025-08-11T08:58:39.358Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 7):♯11","scaleName":"WT (from 7)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:9","scaleName":"Pentatonic"}]},
            "♯1-2 augmented explode bright": {"version":"1.0","created":"2025-08-11T08:59:29.092Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 7):♯11","scaleName":"WT (from 7)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):9","scaleName":"Pentatonic (from 2)"}]},
            "♯1-2 spicy bright": {"version":"1.0","created":"2025-08-11T09:00:42.900Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2 (from ♭5):♯11","scaleName":"Pentatonic \"dominant\" ♭2 (from ♭5)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):9","scaleName":"Pentatonic (from 2)"}]},
            "♯1-2 upper tritone decisive": {"version":"1.0","created":"2025-08-12T05:14:49.003Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♭5:♯11","scaleName":"Pentatonic \"dominant\" ♭2, ♭5"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:9","scaleName":"Pentatonic"}]},
            "♯1-2 upper tritone bright": {"version":"1.0","created":"2025-08-12T05:15:44.138Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♭5:♯11","scaleName":"Pentatonic \"dominant\" ♭2, ♭5"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):9","scaleName":"Pentatonic (from 2)"}]},
            "♯1-2 upper minor decisive": {"version":"1.0","created":"2025-08-12T05:16:13.596Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♭5:♯11","scaleName":"Pentatonic \"dominant\" ♯2, ♭5"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:9","scaleName":"Pentatonic"}]},
            "♯1-2 upper minor soft": {"version":"1.0","created":"2025-08-12T05:18:17.550Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♭5:♯11","scaleName":"Pentatonic \"dominant\" ♯2, ♭5"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":9","scaleName":"Pentatonic \"major 7\""}]},
            "♯1-2 upper augmented decisive": {"version":"1.0","created":"2025-08-12T05:21:15.291Z","progression":[{"symbol":"V7","currentTopNote":"♯11","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 7):♯11","scaleName":"WT (from 7)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":9","scaleName":"Pentatonic \"major 7\""}]},
            "♯2-3 whole tone upwards": {"version":"1.0","created":"2025-08-12T07:43:15.755Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 2):♭13","scaleName":"WT (from 2)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):3","scaleName":"Pentatonic (from 5)"}]},
            "♯2-3 whole tone upwards decisive": {"version":"1.0","created":"2025-08-12T07:48:40.191Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 2):♭13","scaleName":"WT (from 2)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:3","scaleName":"Pentatonic"}]},
            "♯2-3 rooted whole tone upwards": {"version":"1.0","created":"2025-08-12T07:50:26.135Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 3):♭13","scaleName":"WT (from 3)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):3","scaleName":"Pentatonic (from 5)"}]},
            "♯2-3 rooted whole tone upwards decisive": {"version":"1.0","created":"2025-08-12T07:50:59.584Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 3):♭13","scaleName":"WT (from 3)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:3","scaleName":"Pentatonic"}]},
            "♯2-3 rich": {"version":"1.0","created":"2025-08-12T07:51:54.043Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♯5:♭13","scaleName":"Pentatonic \"dominant\" ♯2, ♯5"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):3","scaleName":"Pentatonic (from 5)"}]},
            "♯2-3 worries leap": {"version":"1.0","created":"2025-08-12T07:55:14.053Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♯5:♭13","scaleName":"Pentatonic \"dominant\" ♭2, ♯5"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):3","scaleName":"Pentatonic (from 5)"}]},
            "♯2-3 spicy": {"version":"1.0","created":"2025-08-12T07:55:52.585Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" (from ♭5):♭13","scaleName":"Pentatonic \"dominant\" (from ♭5)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):3","scaleName":"Pentatonic (from 5)"}]},
            "♯2-3 lower tritone resolution": {"version":"1.0","created":"2025-08-12T07:57:31.883Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" (from ♭5):♭13","scaleName":"Pentatonic \"dominant\" (from ♭5)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:3","scaleName":"Pentatonic"}]},
            "♯2-3 cool bright": {"version":"1.0","created":"2025-08-12T07:58:01.598Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♯5:♭13","scaleName":"Pentatonic \"dominant\" ♯2, ♯5"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):3","scaleName":"Pentatonic (from 2)"}]},
            "♯2-3 worries resolution": {"version":"1.0","created":"2025-08-12T07:58:44.646Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic ♭3 (from ♭2):♭13","scaleName":"Pentatonic ♭3 (from ♭2)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):3","scaleName":"Pentatonic (from 5)"}]},
            "♯2-3 worries decisive": {"version":"1.0","created":"2025-08-12T09:26:49.958Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic ♭3 (from ♭2):♭13","scaleName":"Pentatonic ♭3 (from ♭2)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:3","scaleName":"Pentatonic"}]},
            "♯2-3 upper brightness": {"version":"1.0","created":"2025-08-12T09:27:49.928Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" (from ♭5):♭13","scaleName":"Pentatonic \"dominant\" (from ♭5)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):3","scaleName":"Pentatonic (from 2)"}]},
            "♯2-3 sad to bright": {"version":"1.0","created":"2025-08-12T09:29:49.811Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic ♭3 (from ♭2):♭13","scaleName":"Pentatonic ♭3 (from ♭2)"},{"symbol":"I","currentTopNote":"3","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):3","scaleName":"Pentatonic (from 2)"}]},
            "♭3-2 small strech": {"version":"1.0","created":"2025-08-12T09:35:54.253Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"WT (from ♭6):♭13","scaleName":"WT (from ♭6)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):9","scaleName":"Pentatonic (from 5)"}]},
            "♭3-2 decisive strech": {"version":"1.0","created":"2025-08-12T09:36:38.263Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"WT (from ♭6):♭13","scaleName":"WT (from ♭6)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:9","scaleName":"Pentatonic"}]},
            "♭3-2 augmented soft": {"version":"1.0","created":"2025-08-12T09:38:11.086Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"WT (from ♭6):♭13","scaleName":"WT (from ♭6)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":9","scaleName":"Pentatonic \"major 7\""}]},
            "♭3-2 no worries": {"version":"1.0","created":"2025-08-12T09:39:25.578Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♯5:♭13","scaleName":"Pentatonic \"dominant\" ♭2, ♯5"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):9","scaleName":"Pentatonic (from 5)"}]},
            "♭3-2 fourths landing": {"version":"1.0","created":"2025-08-12T09:40:10.846Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♯5:♭13","scaleName":"Pentatonic \"dominant\" ♯2, ♯5"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):9","scaleName":"Pentatonic (from 5)"}]},
            "♭3-2 whole tone neat": {"version":"1.0","created":"2025-08-12T09:43:26.798Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 3):♭13","scaleName":"WT (from 3)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":9","scaleName":"Pentatonic \"major 7\""}]},
            "♭3-2 no worries decisive": {"version":"1.0","created":"2025-08-12T09:44:09.232Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♯5:♭13","scaleName":"Pentatonic \"dominant\" ♭2, ♯5"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:9","scaleName":"Pentatonic"}]},
            "♭3-2 fouths landing decisive": {"version":"1.0","created":"2025-08-12T09:44:35.976Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♯5:♭13","scaleName":"Pentatonic \"dominant\" ♯2, ♯5"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:9","scaleName":"Pentatonic"}]},
            "♭3-2 cool soft": {"version":"1.0","created":"2025-08-12T09:45:20.155Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♯5:♭13","scaleName":"Pentatonic \"dominant\" ♯2, ♯5"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":9","scaleName":"Pentatonic \"major 7\""}]},
            "♭3-2 whole tone downwards": {"version":"1.0","created":"2025-08-13T07:02:33.227Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 3):♭13","scaleName":"WT (from 3)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:9","scaleName":"Pentatonic"}]},
            "♭3-2 lower augmented decisive": {"version":"1.0","created":"2025-08-13T07:04:04.050Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"WT (from 2):♭13","scaleName":"WT (from 2)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:9","scaleName":"Pentatonic"}]},
            "♭3-2 tritone soft": {"version":"1.0","created":"2025-08-13T07:05:05.097Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" (from ♭5):♭13","scaleName":"Pentatonic \"dominant\" (from ♭5)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":9","scaleName":"Pentatonic \"major 7\""}]},
            "♭3-2 worries bright": {"version":"1.0","created":"2025-08-13T07:05:56.289Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♭2, ♯5:♭13","scaleName":"Pentatonic \"dominant\" ♭2, ♯5"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):9","scaleName":"Pentatonic (from 2)"}]},
            "♭3-2 cool bright": {"version":"1.0","created":"2025-08-13T07:06:44.559Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" ♯2, ♯5:♭13","scaleName":"Pentatonic \"dominant\" ♯2, ♯5"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 2):9","scaleName":"Pentatonic (from 2)"}]},
            "♭3-2 sad relief": {"version":"1.0","created":"2025-08-13T07:07:26.333Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic ♭3 (from ♭2):♭13","scaleName":"Pentatonic ♭3 (from ♭2)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic (from 5):9","scaleName":"Pentatonic (from 5)"}]},
            "♭3-2 sad decisive": {"version":"1.0","created":"2025-08-13T07:08:07.835Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic ♭3 (from ♭2):♭13","scaleName":"Pentatonic ♭3 (from ♭2)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:9","scaleName":"Pentatonic"}]},
            "♭3-2 sad soft": {"version":"1.0","created":"2025-08-13T07:08:54.501Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic ♭3 (from ♭2):♭13","scaleName":"Pentatonic ♭3 (from ♭2)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"major 7\":9","scaleName":"Pentatonic \"major 7\""}]},
            "♭3-2 downwards decisive": {"version":"1.0","created":"2025-08-13T07:09:24.859Z","progression":[{"symbol":"V7","currentTopNote":"♭13","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic \"dominant\" (from ♭5):♭13","scaleName":"Pentatonic \"dominant\" (from ♭5)"},{"symbol":"I","currentTopNote":"9","currentVoicingIndex":0,"selectedVoicingKey":"Pentatonic:9","scaleName":"Pentatonic"}]}
        };

        // Function to check if a progression exists in the library
        function isProgressionInLibrary(v7TopNote, v7ScaleName, iTopNote, iScaleName) {
            // Check if this exact voicing combination exists in embeddedProgressions
            for (const [fileName, data] of Object.entries(embeddedProgressions)) {
                if (data.progression && data.progression.length >= 2) {
                    const v7Chord = data.progression[0];
                    const iChord = data.progression[1];
                    
                    if (v7Chord.currentTopNote === v7TopNote && 
                        v7Chord.scaleName === v7ScaleName &&
                        iChord.currentTopNote === iTopNote && 
                        iChord.scaleName === iScaleName) {
                        return { inLibrary: true, fileName: fileName };
                    }
                }
            }
            return { inLibrary: false, fileName: null };
        }

        // Global variables for file-based progressions
        let allProgressionsDataFiles = {};
        let currentFilterFiles = 'all';
        
        // State preservation for library page
        let libraryPageState = {
            selectedTopNoteLine: null,
            scrollPosition: 0
        };

        function saveLibraryPageState() {
            // Save currently selected top-note-line
            const activeNavItem = document.querySelector('#top-note-lines-files .top-note-line-item.active');
            if (activeNavItem) {
                const topNoteLineName = activeNavItem.querySelector('.top-note-line-name').textContent;
                libraryPageState.selectedTopNoteLine = topNoteLineName;
            }
            
            // Save scroll position of the content area
            const contentArea = document.getElementById('progressions-content-files');
            if (contentArea) {
                libraryPageState.scrollPosition = contentArea.scrollTop;
            }
        }

        function restoreLibraryPageState() {
            if (libraryPageState.selectedTopNoteLine) {
                // Find and click the previously selected top-note-line
                const navItems = document.querySelectorAll('#top-note-lines-files .top-note-line-item');
                for (const item of navItems) {
                    const topNoteLineName = item.querySelector('.top-note-line-name').textContent;
                    if (topNoteLineName === libraryPageState.selectedTopNoteLine) {
                        item.click();
                        break;
                    }
                }
                
                // Restore scroll position after content loads
                setTimeout(() => {
                    const contentArea = document.getElementById('progressions-content-files');
                    if (contentArea && libraryPageState.scrollPosition > 0) {
                        contentArea.scrollTop = libraryPageState.scrollPosition;
                    }
                }, 200);
            }
        }
        
        function compareTopNoteLines(intervalA, intervalB) {
            // Compare interval strings like "2-2", "3-3", "♭7-♭7", etc.
            // Split intervals into start and end notes
            const [aStart, aEnd] = intervalA.split('-');
            const [bStart, bEnd] = intervalB.split('-');
            
            // Convert notes to semitone values for comparison
            const noteToSemitone = (note) => {
                const baseNotes = {
                    '1': 0, '2': 2, '3': 4, '4': 5, '5': 7, '6': 9, '7': 11
                };
                
                // Handle accidentals
                if (note.includes('♭')) {
                    const baseNote = note.replace('♭', '');
                    return (baseNotes[baseNote] || 0) - 1;
                } else if (note.includes('♯')) {
                    const baseNote = note.replace('♯', '');
                    return (baseNotes[baseNote] || 0) + 1;
                } else if (note.includes('♮')) {
                    const baseNote = note.replace('♮', '');
                    return baseNotes[baseNote] || 0;
                }
                
                return baseNotes[note] || 0;
            };
            
            // Calculate shortest interval distance (considering octave equivalence)
            const aStartSemi = noteToSemitone(aStart);
            const aEndSemi = noteToSemitone(aEnd);
            const bStartSemi = noteToSemitone(bStart);
            const bEndSemi = noteToSemitone(bEnd);
            
            // Calculate both upward and downward distances, take the minimum
            const aUpward = (aEndSemi - aStartSemi + 12) % 12;
            const aDownward = (aStartSemi - aEndSemi + 12) % 12;
            const aInterval = Math.min(aUpward, aDownward);
            
            const bUpward = (bEndSemi - bStartSemi + 12) % 12;
            const bDownward = (bStartSemi - bEndSemi + 12) % 12;
            const bInterval = Math.min(bUpward, bDownward);
            
            // First sort by shortest interval distance (smaller intervals first)
            if (aInterval !== bInterval) {
                return aInterval - bInterval;
            }
            
            // Then sort alphabetically by interval string, ignoring accidentals for base comparison
            const normalizeForSorting = (interval) => {
                return interval.replace(/♯|♭|♮/g, '');
            };
            
            const aNormalized = normalizeForSorting(intervalA);
            const bNormalized = normalizeForSorting(intervalB);
            
            if (aNormalized !== bNormalized) {
                return aNormalized.localeCompare(bNormalized);
            }
            
            // Finally, if base intervals are the same, sort by original (with accidentals)
            return intervalA.localeCompare(intervalB);
        }
        
        function getMovementType(movement) {
            // Extract movement type from movement object for filtering
            if (!movement) return 'unknown';
            
            // The movement object should have a type property: 'common', 'step', or 'leap'
            return movement.type || 'unknown';
        }
        
        function calculateTotalSemitones(movement) {
            // Calculate total semitones for progression sorting
            if (!movement) return 0;
            
            // Return the semitones or absInterval from the movement object
            return movement.semitones || movement.absInterval || 0;
        }
        
        function calculateActualVoiceMovement(progression) {
            // Use the existing voice leading analysis to get accurate semitone calculation
            if (!progression.v7.voicing || !progression.i.voicing) return 0;
            
            const movements = analyzeVoiceLeadingDirect(progression.v7.voicing, progression.i.voicing);
            if (!movements || movements.length === 0) return 0;
            
            // Calculate total semitones using the same logic as the movement summary
            const totalSemitones = movements.reduce((sum, m) => {
                return sum + (m.semitones || m.absInterval || 0);
            }, 0);
            
            return totalSemitones;
        }
        
        function countAccidentals(progression) {
            // Count ♭, ♯, ♮ symbols in the actual voicing notes (chord tones)
            let count = 0;
            
            // Count accidentals in V7 chord voicing
            if (progression.v7 && progression.v7.voicing) {
                progression.v7.voicing.forEach(note => {
                    if (note && typeof note === 'string') {
                        count += (note.match(/[♭♯♮]/g) || []).length;
                    }
                });
            }
            
            // Count accidentals in I chord voicing
            if (progression.i && progression.i.voicing) {
                progression.i.voicing.forEach(note => {
                    if (note && typeof note === 'string') {
                        count += (note.match(/[♭♯♮]/g) || []).length;
                    }
                });
            }
            
            return count;
        }

        function loadProgressionLibraryMode() {
            loadProgressionTypeFiles();
            
            // Ensure the layout is properly initialized
            setTimeout(() => {
                const navContainer = document.getElementById('top-note-lines-files');
                const contentContainer = document.getElementById('progressions-content-files');
                
                if (navContainer && contentContainer) {
                    if (contentContainer.innerHTML.trim() === '' || contentContainer.innerHTML.includes('Loading progressions...')) {
                        loadProgressionTypeFiles();
                    }
                }
            }, 100);
        }

        function loadProgressionTypeFiles() {
            const progressionType = document.getElementById('progression-type-files').value;
            const content = document.getElementById('progressions-content-files');
            const loadingMessage = document.querySelector('#progression-library-mode .default-message');
            
            if (!content) return;
            
            // Show default message initially
            if (loadingMessage) {
                loadingMessage.style.display = 'block';
            }
            content.innerHTML = '';
            
            if (progressionType === 'V7-I') {
                const htmlContent = generateV7IProgressionsFromFiles();
                // Content is empty initially - navigation is populated, content shows on selection
                content.innerHTML = htmlContent;
            }
        }

        function generateV7IProgressionsFromFiles() {
            
            // Process embedded progressions and organize by top-note-lines
            const progressionsByTopNoteLine = {};
            
            Object.entries(embeddedProgressions).forEach(([fileName, data]) => {
                if (!data.progression || data.progression.length !== 2) return;
                
                const v7Chord = data.progression[0];
                const iChord = data.progression[1];
                
                // Calculate top-note-line relative to tonal center
                const iTonalNote = getTonicRelativeNote(iChord.currentTopNote, 'I');
                const v7TonalNote = getTonicRelativeNote(v7Chord.currentTopNote, 'V7', iChord.currentTopNote);
                
                if (!v7TonalNote || !iTonalNote) return;
                
                // Calculate movement between top notes
                const movements = calculateAllTopNoteMovements(v7TonalNote, iTonalNote);
                
                movements.forEach(movement => {
                    const topNoteLine = `${v7TonalNote}-${iTonalNote}`;
                    
                    // Skip ♯1-2 progressions entirely - use ♭2-2 instead (same interval, different enharmonic spelling)  
                    // ♭2-2 will be displayed as ♯1-2 in the UI for better readability
                    if (topNoteLine === '♯1-2') {
                        return;
                    }
                    
                    // Skip upward movements for ♭2-1 progressions (only show downward)
                    if (topNoteLine === '♭2-1' && movement.direction === '↗') {
                        return;
                    }
                    
                    // Skip downward movements for ♯2-3 progressions (only show upward)
                    if (topNoteLine === '♯2-3' && movement.direction === '↘') {
                        return;
                    }
                    
                    // Skip upward movements for ♭3-2 progressions (only show downward)
                    if (topNoteLine === '♭3-2' && movement.direction === '↗') {
                        return;
                    }
                    
                    // Skip downward movements for ♭2-2 progressions (only show upward)
                    if (topNoteLine === '♭2-2' && movement.direction === '↘') {
                        return;
                    }
                    
                    // Normalize enharmonic equivalents to consolidate navigation entries
                    // Convert ♭2-2 to ♯1-2 internally so they're treated as the same interval
                    let normalizedTopNoteLine = topNoteLine;
                    if (topNoteLine === '♭2-2') {
                        normalizedTopNoteLine = '♯1-2';
                    }
                    
                    const directionKey = `${normalizedTopNoteLine} ${movement.direction}`;
                    
                    
                    if (!progressionsByTopNoteLine[directionKey]) {
                        progressionsByTopNoteLine[directionKey] = [];
                    }
                    
                    // Create progression object matching Raw page format
                    const progression = {
                        v7: {
                            topNote: v7Chord.currentTopNote,
                            scaleName: v7Chord.scaleName,
                            voicing: voicingData.dominant[v7Chord.scaleName]?.[v7Chord.currentTopNote] || []
                        },
                        i: {
                            topNote: iChord.currentTopNote, 
                            scaleName: iChord.scaleName,
                            voicing: voicingData.major[iChord.scaleName]?.[iChord.currentTopNote] || []
                        },
                        movement: movement,
                        fileName: fileName,
                        originalData: data
                    };
                    
                    progressionsByTopNoteLine[directionKey].push(progression);
                });
            });
            
            
            // Store for filtering and later access
            allProgressionsDataFiles = progressionsByTopNoteLine;
            
            // Only update the navigation, don't show content initially
            updateTopNoteLinesNavFiles(progressionsByTopNoteLine);
            
            // Return empty content initially - progressions will be shown when a line is selected
            return '';
        }

        function generateProgressionsHTMLFromFiles(progressionsByTopNoteLine, chordType) {
            // Update top-note-lines navigation
            updateTopNoteLinesNavFiles(progressionsByTopNoteLine);
            
            let html = '';
            const sortedTopNoteLines = Object.keys(progressionsByTopNoteLine).sort((a, b) => {
                const aInterval = a.split(' ')[0];
                const bInterval = b.split(' ')[0];
                return compareTopNoteLines(aInterval, bInterval);
            });

            sortedTopNoteLines.forEach(topNoteLine => {
                const progressions = progressionsByTopNoteLine[topNoteLine];
                if (progressions.length === 0) return;

                const [interval, direction] = topNoteLine.split(' ');
                const [v7Note, iNote] = interval.split('-');
                const movementType = getMovementType(progressions[0].movement);
                
                // Format display: use dash for intervals, only add direction if not common tone
                const headerLabel = movementType === 'common' 
                    ? `${v7Note} - ${iNote}` 
                    : `${v7Note} - ${iNote} ${direction}`;
                
                html += `
                    <div class="top-note-line" id="files-${topNoteLine.replace(/[^a-zA-Z0-9]/g, '')}" data-interval="${interval}" data-filter-type="${movementType}">
                        <div class="interval-header">
                            <h4 class="interval-title">${headerLabel}</h4>
                            <div class="interval-summary">${progressions.length} progression${progressions.length !== 1 ? 's' : ''}</div>
                        </div>
                        <div class="progression-variations">
                `;

                // Sort progressions by semitone total (ascending)
                const sortedProgressions = progressions.sort((a, b) => {
                    const aSemitones = calculateTotalSemitones(a.movement);
                    const bSemitones = calculateTotalSemitones(b.movement);
                    return aSemitones - bSemitones;
                });

                sortedProgressions.forEach((progression, index) => {
                    html += generateProgressionVariationHTMLFiles(progression, chordType, index);
                });

                html += `
                        </div>
                    </div>
                `;
            });

            return html || '<p>No progressions found matching the current criteria.</p>';
        }

        function updateTopNoteLinesNavFiles(progressionsByTopNoteLine) {
            const navContainer = document.getElementById('top-note-lines-files');
            const sortedTopNoteLines = Object.keys(progressionsByTopNoteLine).sort((a, b) => {
                const aInterval = a.split(' ')[0];
                const bInterval = b.split(' ')[0];
                return compareTopNoteLines(aInterval, bInterval);
            });

            let navHtml = '';
            sortedTopNoteLines.forEach(topNoteLine => {
                const progressions = progressionsByTopNoteLine[topNoteLine];
                const [interval, direction] = topNoteLine.split(' ');
                const [v7Note, iNote] = interval.split('-');
                const movementType = getMovementType(progressions[0].movement);
                
                // Format display to match Raw page: just show interval without direction
                // Use the same display conversion as other functions (e.g., ♭2-2 → ♯1-2)
                const displayLabel = getTopNoteLineDisplayLabel(topNoteLine).split(' ')[0];
                
                    
                navHtml += `
                    <div class="top-note-line-item" data-filter-type="${movementType}" onclick="scrollToTopNoteLineFiles('${topNoteLine}')">
                        <span class="top-note-line-name">${displayLabel}</span>
                        <span class="top-note-line-count">${progressions.length}</span>
                    </div>
                `;
            });

            navContainer.innerHTML = navHtml;
        }

        function generateProgressionVariationHTMLFiles(progression, chordType, index) {
            // Format voicings for display (copy from Raw page)
            const v7VoicingFormatted = formatVoicingForDisplay(progression.v7.voicing);
            const iVoicingFormatted = formatVoicingForDisplay(progression.i.voicing);
            
            // Get voice leading analysis - use the direct function since we have voicing arrays
            const voiceLeadingAnalysis = analyzeVoiceLeadingDirect(progression.v7.voicing, progression.i.voicing);
            
            return `
                <div class="progression-variation">
                    <div class="progression-title">${progression.fileName}</div>
                    <div class="library-progression-display">
                        <div class="library-chord">
                            <div class="chord-header">
                                <span class="chord-symbol">V7</span>
                            </div>
                            <div class="voicing-display">
                                <div class="voicing-content">${v7VoicingFormatted}</div>
                                <div class="scale-indicator">${progression.v7.scaleName}</div>
                            </div>
                        </div>
                        
                        <div class="voice-leading-connector library">
                            ${generateLibraryVoiceLeadingConnector(progression.v7, progression.i, progression.movement)}
                        </div>
                        
                        <div class="library-chord">
                            <div class="chord-header">
                                <span class="chord-symbol">${chordType === 'major' ? 'I' : 'i'}</span>
                            </div>
                            <div class="voicing-display">
                                <div class="voicing-content">${iVoicingFormatted}</div>
                                <div class="scale-indicator">${progression.i.scaleName}</div>
                            </div>
                        </div>
                    </div>
                    <div class="progression-actions">
                        <button class="load-progression-btn" onclick="loadProgressionFromFile('${progression.fileName}', this)" data-progression='${JSON.stringify(progression.originalData)}'>
                            Load in Creator
                        </button>
                    </div>
                </div>
            `;
        }

        // Search function for file-based progressions

        function filterTopNoteLinesFiles() {
            applyFiltersFiles();
        }

        function applyFiltersFiles() {
            const searchTerm = document.getElementById('search-input-files').value.toLowerCase();
            const topNoteLines = document.querySelectorAll('#progressions-content-files .top-note-line');
            const navItems = document.querySelectorAll('#top-note-lines-files .top-note-line-item');

            topNoteLines.forEach((line, index) => {
                const interval = line.dataset.interval;
                
                // Check search match only
                const matchesSearch = !searchTerm || interval.toLowerCase().includes(searchTerm);
                
                line.style.display = matchesSearch ? 'block' : 'none';
                
                // Update corresponding nav item
                if (navItems[index]) {
                    navItems[index].style.display = matchesSearch ? 'flex' : 'none';
                }
            });
        }

        function scrollToTopNoteLineFiles(topNoteLine) {
            // Update navigation active state
            document.querySelectorAll('#top-note-lines-files .top-note-line-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Set active item
            event.target.closest('.top-note-line-item').classList.add('active');
            
            // Show progressions for selected top-note-line
            showProgressionsForTopNoteLine(topNoteLine);
        }
        
        function showProgressionsForTopNoteLine(topNoteLineKey) {
            const contentDiv = document.getElementById('progressions-content-files');
            const defaultMessage = document.querySelector('.default-message');
            const titleElement = document.getElementById('current-filter-title-files');
            
            if (!allProgressionsDataFiles[topNoteLineKey]) {
                contentDiv.innerHTML = '<p>No progressions found for this top-note-line.</p>';
                return;
            }
            
            const progressions = allProgressionsDataFiles[topNoteLineKey];
            const [interval, direction] = topNoteLineKey.split(' ');
            const [v7Note, iNote] = interval.split('-');
            const movementType = getMovementType(progressions[0].movement);
            
            // Update title
            const displayLabel = movementType === 'common' 
                ? `${v7Note} - ${iNote}` 
                : `${v7Note} - ${iNote} ${direction}`;
            titleElement.textContent = `Top-Note-Line: ${displayLabel}`;
            
            // Hide default message and show progressions
            if (defaultMessage) defaultMessage.style.display = 'none';
            
            // Sort progressions first by accidentals count, then by semitone total (both ascending)
            const sortedProgressions = progressions.sort((a, b) => {
                // First priority: fewer accidentals
                const aAccidentals = countAccidentals(a);
                const bAccidentals = countAccidentals(b);
                
                if (aAccidentals !== bAccidentals) {
                    return aAccidentals - bAccidentals;
                }
                
                // Second priority: fewer semitones (use actual voice movement calculation)
                const aSemitones = calculateActualVoiceMovement(a);
                const bSemitones = calculateActualVoiceMovement(b);
                
                if (aSemitones !== bSemitones) {
                    return aSemitones - bSemitones;
                }
                
                // Third priority: alphabetical by file name for stable sorting
                return a.fileName.localeCompare(b.fileName);
            });
            
            
            // Generate HTML for progressions (without interval header)
            let html = '<div class="progression-variations">';
            sortedProgressions.forEach((progression, index) => {
                html += generateProgressionVariationHTMLFiles(progression, 'major', index);
            });
            html += '</div>';
            
            contentDiv.innerHTML = html;
            
            // Add touch event handlers for mobile highlighting
            addTouchHighlighting();
        }

        function addTouchHighlighting() {
            const progressionCards = document.querySelectorAll('.progression-variation');
            
            progressionCards.forEach(card => {
                // Handle touch start (finger down)
                card.addEventListener('touchstart', function(e) {
                    // Remove active class from all other cards
                    progressionCards.forEach(otherCard => {
                        if (otherCard !== card) {
                            otherCard.classList.remove('touch-active');
                        }
                    });
                    // Add active class to touched card
                    card.classList.add('touch-active');
                }, { passive: true });

                // Handle touch end (finger up) - remove highlight after delay
                card.addEventListener('touchend', function(e) {
                    setTimeout(() => {
                        card.classList.remove('touch-active');
                    }, 150);
                }, { passive: true });

                // Handle touch cancel (touch interrupted)
                card.addEventListener('touchcancel', function(e) {
                    card.classList.remove('touch-active');
                }, { passive: true });
            });
        }

        function loadProgressionFromFileData(fileName, buttonElement) {
            const progressionData = JSON.parse(buttonElement.getAttribute('data-progression'));
            
            // Find the original progression data from embedded progressions
            const originalData = embeddedProgressions[fileName];
            if (!originalData) return;
            
            // Switch to Create Progression mode and load the progression
            switchMode('progression');
            
            // Save state before loading new progression
            saveToHistory();
            
            // Clear existing progression
            currentProgression = [];
            
            // Add chords from the loaded progression
            originalData.progression.forEach(chordData => {
                const chord = {
                    id: Date.now() + Math.random(),
                    symbol: chordData.symbol,
                    currentTopNote: chordData.currentTopNote,
                    selectedVoicingKey: chordData.selectedVoicingKey,
                    scaleName: chordData.scaleName,
                    selectedVoicing: null,
                    currentVoicingIndex: chordData.currentVoicingIndex || 0,
                    voicingWithPositions: null
                };
                
                // Create selectedVoicing object to properly set up the voicing
                if (chordData.scaleName && chordData.currentTopNote) {
                    const chordType = getChordType(chordData.symbol);
                    const voicingData = getVoicingData(chordType);
                    if (voicingData[chordData.scaleName] && voicingData[chordData.scaleName][chordData.currentTopNote]) {
                        const selectedVoicing = {
                            scaleName: chordData.scaleName,
                            topNote: chordData.currentTopNote,
                            voicing: voicingData[chordData.scaleName][chordData.currentTopNote]
                        };
                        updateChordVoicing(chord, selectedVoicing);
                    }
                }
                
                currentProgression.push(chord);
            });
            
            // Update the display
            renderProgression();
        }

        function displayLoadedProgressions(progressions) {
            const content = document.getElementById('progression-files-content');
            
            // Sort progressions by filename
            progressions.sort((a, b) => a.fileName.localeCompare(b.fileName));
            
            let html = '<div class="progression-files-grid">';
            
            progressions.forEach(prog => {
                const { fileName, data } = prog;
                if (!data.progression || data.progression.length !== 2) return;
                
                const v7Chord = data.progression[0];
                const iChord = data.progression[1];
                
                // Get voice leading analysis
                const voiceLeading = calculateVoiceLeadingFromFile(v7Chord, iChord);
                
                html += `
                    <div class="progression-file-item">
                        <div class="progression-file-header">
                            <div class="progression-file-name">${fileName}</div>
                        </div>
                        <div class="progression-file-content">
                            <div class="progression-file-chords">
                                <div class="chord-info">
                                    <div class="chord-symbol">V7</div>
                                    <div class="chord-details">
                                        <div class="scale-name">${v7Chord.scaleName}</div>
                                        <div class="top-note">Top: ${v7Chord.currentTopNote}</div>
                                    </div>
                                </div>
                                <div class="voice-leading-arrow">→</div>
                                <div class="chord-info">
                                    <div class="chord-symbol">I</div>
                                    <div class="chord-details">
                                        <div class="scale-name">${iChord.scaleName}</div>
                                        <div class="top-note">Top: ${iChord.currentTopNote}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="voice-leading-analysis">
                                ${voiceLeading}
                            </div>
                        </div>
                        <div class="progression-file-actions">
                            <button class="load-progression-btn" onclick="loadProgressionFromFile('${fileName}', this)" data-progression='${JSON.stringify(data)}'>
                                Load Progression
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        function getNoteSemitone(note) {
            // Map note names to semitone values (C = 0)
            const noteMap = {
                '1': 0, 'C': 0,
                '♭2': 1, '♭9': 1, 'D♭': 1, 'C♯': 1,
                '2': 2, '9': 2, 'D': 2,
                '♯2': 3, '♯9': 3, '♭3': 3, 'E♭': 3, 'D♯': 3,
                '3': 4, 'E': 4,
                '4': 5, '11': 5, 'F': 5,
                '♯4': 6, '♯11': 6, '♭5': 6, 'F♯': 6, 'G♭': 6,
                '5': 7, 'G': 7,
                '♯5': 8, '♭6': 8, '♭13': 8, 'A♭': 8, 'G♯': 8,
                '6': 9, '13': 9, 'A': 9,
                '♯6': 10, '♭7': 10, 'B♭': 10, 'A♯': 10,
                '7': 11, '♮7': 11, 'maj7': 11, 'B': 11
            };
            return noteMap[note] !== undefined ? noteMap[note] : null;
        }

        function calculateVoiceLeadingFromFile(v7Chord, iChord) {
            // Get voicings from voicing data
            const v7Voicing = voicingData.dominant[v7Chord.scaleName]?.[v7Chord.currentTopNote];
            const iVoicing = voicingData.major[iChord.scaleName]?.[iChord.currentTopNote];
            
            if (!v7Voicing || !iVoicing) {
                return 'Voice leading data unavailable';
            }
            
            // Calculate voice leading (simplified version)
            const movements = [];
            let totalSemitones = 0;
            let leaps = 0;
            
            for (let i = 0; i < 6; i++) {
                const fromNote = v7Voicing[i];
                const toNote = iVoicing[i];
                
                if (fromNote && toNote && fromNote !== '' && toNote !== '') {
                    const fromSemitone = getNoteSemitone(fromNote);
                    const toSemitone = getNoteSemitone(toNote);
                    
                    if (fromSemitone !== null && toSemitone !== null) {
                        let interval = Math.abs(toSemitone - fromSemitone);
                        if (interval > 6) interval = 12 - interval; // Use closest direction
                        
                        totalSemitones += interval;
                        if (interval > 2) leaps++;
                    }
                }
            }
            
            const summaryParts = [];
            if (totalSemitones > 0) summaryParts.push(`${totalSemitones}S`);
            if (leaps > 0) summaryParts.push(`${leaps}L`);
            
            return summaryParts.length > 0 ? summaryParts.join(' ') : '0S';
        }

        function loadProgressionFromFile(fileName, buttonElement) {
            const progressionData = JSON.parse(buttonElement.getAttribute('data-progression'));
            
            // Switch to Create Progression mode and load the progression
            switchMode('progression');
            
            // Save state before loading new progression
            saveToHistory();
            
            // Clear existing progression
            currentProgression = [];
            
            // Add chords from the loaded progression
            progressionData.progression.forEach(chordData => {
                const chord = {
                    id: Date.now() + Math.random(),
                    symbol: chordData.symbol,
                    currentTopNote: chordData.currentTopNote,
                    selectedVoicingKey: chordData.selectedVoicingKey,
                    scaleName: chordData.scaleName,
                    selectedVoicing: null,
                    currentVoicingIndex: chordData.currentVoicingIndex || 0,
                    voicingWithPositions: null
                };
                
                // Create selectedVoicing object to properly set up the voicing
                if (chordData.scaleName && chordData.currentTopNote) {
                    const chordType = getChordType(chordData.symbol);
                    const voicingData = getVoicingData(chordType);
                    if (voicingData[chordData.scaleName] && voicingData[chordData.scaleName][chordData.currentTopNote]) {
                        const selectedVoicing = {
                            scaleName: chordData.scaleName,
                            topNote: chordData.currentTopNote,
                            voicing: voicingData[chordData.scaleName][chordData.currentTopNote]
                        };
                        updateChordVoicing(chord, selectedVoicing);
                    }
                }
                
                currentProgression.push(chord);
            });
            
            // Update the display
            renderProgression();
        }

        // Initialize the app
        switchMode('progression-library');
        
        // Initialize history with empty progression after mode switch
        // Use setTimeout to ensure DOM is ready
        setTimeout(() => {
            progressionHistory = [JSON.parse(JSON.stringify(currentProgression))];
            historyIndex = 0;
            updateHistoryButtons();
        }, 0);
        
        // Ensure history is properly initialized when entering progression mode
        function ensureHistoryInitialized() {
            if (progressionHistory.length === 0) {
                console.log('🏁 ensureHistoryInitialized: INITIALIZING', {
                    currentProgression: currentProgression.map(c => `${c.symbol}(${c.currentTopNote})`)
                });
                progressionHistory = [JSON.parse(JSON.stringify(currentProgression))];
                historyIndex = 0;
                updateHistoryButtons();
            } else {
                console.log('🏁 ensureHistoryInitialized: ALREADY INITIALIZED', {
                    historyLength: progressionHistory.length,
                    historyIndex
                });
            }
        }

        // Add keyboard shortcuts for undo/redo
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undoAction();
            } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                e.preventDefault();
                redoAction();
            }
        });
    </script>
</body>
</html>